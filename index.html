<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BriteCo Ad Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #008182;
            color: #272D3F;
        }

        header {
            background: #272D3F;
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .logo span {
            color: #31D7CA;
        }

        main {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 2.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: #272D3F;
        }

        h2 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: #272D3F;
        }

        .platform-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .platform-card {
            border: 3px solid #E1E7EF;
            border-radius: 12px;
            padding: 2rem;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .platform-card:hover {
            border-color: #31D7CA;
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(49, 215, 202, 0.2);
        }

        .platform-card.selected {
            border-color: #31D7CA;
            background: #F4F7FC;
            box-shadow: 0 4px 12px rgba(49, 215, 202, 0.3);
        }

        .platform-card h3 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .btn-primary {
            background: #FC883A;
            color: white;
            padding: 1rem 2.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.2s;
            margin-top: 2rem;
        }

        .btn-primary:hover {
            background: #e77a33;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(252, 136, 58, 0.3);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #008182;
            color: white;
            padding: 1rem 2.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.2s;
            margin-top: 2rem;
        }

        .btn-secondary:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 129, 130, 0.3);
        }

        .hidden {
            display: none !important;
        }

        textarea {
            width: 100%;
            padding: 1rem;
            border: 2px solid #E1E7EF;
            border-radius: 8px;
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
            min-height: 150px;
        }

        textarea:focus {
            outline: none;
            border-color: #31D7CA;
        }

        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 0;
        }

        .image-upload-area {
            border: 3px dashed #E1E7EF;
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin: 1rem 0;
            background: #fafafa;
        }

        .image-upload-area:hover {
            border-color: #31D7CA;
            background: #F4F7FC;
        }

        .char-count {
            text-align: right;
            font-size: 0.875rem;
            color: #A9C1CB;
            margin-top: 0.5rem;
        }

        .selected-count {
            background: #31D7CA;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            display: inline-block;
            margin-top: 1rem;
        }

        footer {
            background: #272D3F;
            color: #A9C1CB;
            padding: 2rem;
            text-align: center;
            margin-top: 4rem;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(39, 45, 63, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-content {
            background: white;
            padding: 3rem;
            border-radius: 16px;
            text-align: center;
            max-width: 500px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #E1E7EF;
            border-top-color: #31D7CA;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Password Protection Overlay -->
    <div id="passwordOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #272D3F; z-index: 9999; display: flex; align-items: center; justify-content: center;">
        <div style="background: white; padding: 3rem; border-radius: 12px; text-align: center; max-width: 400px; width: 90%;">
            <h2 style="color: #272D3F; margin-bottom: 1rem;">üîí Password Required</h2>
            <p style="color: #666; margin-bottom: 1.5rem;">Enter password to access the tool</p>
            <input type="password" id="passwordInput" placeholder="Enter password" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; margin-bottom: 1rem;" onkeypress="if(event.key==='Enter')checkPassword()">
            <button onclick="checkPassword()" style="width: 100%; padding: 12px; background: #31D7CA; color: #272D3F; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;">Access Tool</button>
            <p id="passwordError" style="color: #e74c3c; margin-top: 1rem; display: none;">Incorrect password</p>
        </div>
    </div>
    <script>
        function checkPassword() {
            const password = document.getElementById('passwordInput').value;
            if (password === 'gobriteco') {
                document.getElementById('passwordOverlay').style.display = 'none';
                sessionStorage.setItem('authenticated', 'true');
            } else {
                document.getElementById('passwordError').style.display = 'block';
            }
        }
        if (sessionStorage.getItem('authenticated') === 'true') {
            document.getElementById('passwordOverlay').style.display = 'none';
        }
    </script>

    <header>
        <div class="header-content">
            <div class="logo" onclick="startOver()" style="cursor: pointer;">
                <span>BriteCo</span> Ad Generator
            </div>
        </div>
    </header>

    <main>
        <!-- Step 1: Platform Selection -->
        <div id="step1" class="card" style="padding: 0; overflow: hidden;">
            <!-- Navy Title Bar -->
            <div style="background: #272D3F; padding: 1.5rem 2.5rem;">
                <h1 style="color: white; margin-bottom: 0.5rem;">Select Your Platforms</h1>
                <p style="color: rgba(255,255,255,0.7); font-size: 1.1rem; margin: 0;">
                    Choose which platforms you want to create ads for. We'll generate the correct sizes for each.
                </p>
            </div>

            <!-- White Content Area -->
            <div style="padding: 2rem 2.5rem;">
                <div class="platform-selector">
                    <div class="platform-card" onclick="togglePlatform('meta', this)">
                        <h3><svg style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.477 2 2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.879V14.89h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.89h-2.33v6.989C18.343 21.129 22 16.99 22 12c0-5.523-4.477-10-10-10z" fill="#1877F2"/></svg>Meta</h3>
                        <p style="color: #7DA3AF; margin-top: 0.5rem;">Facebook & Instagram</p>
                        <p style="color: #A9C1CB; font-size: 0.9rem; margin-top: 0.5rem;">
                            Feed (1:1, 4:5), Stories (9:16), Carousel
                        </p>
                    </div>
                    <div class="platform-card" onclick="togglePlatform('reddit', this)">
                        <h3><svg style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" fill="#FF4500"/><path d="M16.5 12c0-.55-.45-1-1-1-.27 0-.52.11-.7.29-.69-.45-1.63-.74-2.68-.78l.54-2.5 1.73.37c.02.55.47.99 1.03.99.57 0 1.03-.46 1.03-1.03s-.46-1.03-1.03-1.03c-.4 0-.75.23-.92.57l-1.94-.42c-.12-.03-.24.06-.27.18l-.6 2.8c-1.07.03-2.03.32-2.73.78-.18-.18-.43-.29-.7-.29-.55 0-1 .45-1 1 0 .41.25.76.6.91-.02.13-.03.26-.03.4 0 2.04 2.37 3.69 5.3 3.69s5.3-1.65 5.3-3.69c0-.14-.01-.27-.03-.4.35-.15.6-.5.6-.91zm-7.5 1c0-.55.45-1 1-1s1 .45 1 1-.45 1-1 1-1-.45-1-1zm5.62 2.16c-.39.39-1.17.59-2.12.59s-1.73-.2-2.12-.59c-.08-.08-.08-.22 0-.3.08-.08.22-.08.3 0 .28.28.93.44 1.82.44s1.54-.16 1.82-.44c.08-.08.22-.08.3 0 .08.08.08.22 0 .3zm-.12-1.16c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z" fill="white"/></svg>Reddit</h3>
                        <p style="color: #7DA3AF; margin-top: 0.5rem;">Community Ads</p>
                        <p style="color: #A9C1CB; font-size: 0.9rem; margin-top: 0.5rem;">
                            Feed, Sidebar, Banner
                        </p>
                    </div>
                    <div class="platform-card" onclick="togglePlatform('pinterest', this)">
                        <h3><svg style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.477 2 2 6.477 2 12c0 4.237 2.636 7.855 6.356 9.312-.088-.791-.167-2.005.035-2.868.181-.78 1.172-4.97 1.172-4.97s-.299-.598-.299-1.482c0-1.388.805-2.425 1.808-2.425.852 0 1.264.64 1.264 1.408 0 .858-.546 2.14-.828 3.33-.236.995.5 1.807 1.48 1.807 1.778 0 3.144-1.874 3.144-4.58 0-2.393-1.72-4.068-4.177-4.068-2.845 0-4.515 2.135-4.515 4.34 0 .859.331 1.781.745 2.281.082.1.094.187.069.288-.076.316-.245 1.002-.278 1.141-.044.183-.145.222-.335.134-1.249-.581-2.03-2.407-2.03-3.874 0-3.154 2.292-6.052 6.608-6.052 3.469 0 6.165 2.473 6.165 5.776 0 3.447-2.173 6.22-5.19 6.22-1.013 0-1.965-.527-2.292-1.148l-.623 2.378c-.226.869-.835 1.958-1.244 2.621.937.29 1.931.446 2.962.446 5.523 0 10-4.477 10-10S17.523 2 12 2z" fill="#E60023"/></svg>Pinterest</h3>
                        <p style="color: #7DA3AF; margin-top: 0.5rem;">Visual Discovery</p>
                        <p style="color: #A9C1CB; font-size: 0.9rem; margin-top: 0.5rem;">
                            Standard Pin (2:3), Square, Long Pin
                        </p>
                    </div>
                    <div class="platform-card" onclick="togglePlatform('demandgen', this)">
                        <h3><svg style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>Demand Gen</h3>
                        <p style="color: #7DA3AF; margin-top: 0.5rem;">YouTube, Discover, Gmail</p>
                        <p style="color: #A9C1CB; font-size: 0.9rem; margin-top: 0.5rem;">
                            1200x628, 1200x1200, 960x1200, 1080x1920
                        </p>
                    </div>
                    <div class="platform-card" onclick="togglePlatform('pmax', this)">
                        <h3><svg style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>Performance Max</h3>
                        <p style="color: #7DA3AF; margin-top: 0.5rem;">All Google Inventory</p>
                        <p style="color: #A9C1CB; font-size: 0.9rem; margin-top: 0.5rem;">
                            1200x628, 1200x1200, 960x1200
                        </p>
                    </div>
                    <div class="platform-card" onclick="togglePlatform('general', this)">
                        <h3><svg style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="3" width="18" height="18" rx="2" stroke="#31D7CA" stroke-width="2" fill="none"/><circle cx="8.5" cy="8.5" r="1.5" fill="#31D7CA"/><path d="M21 15l-5-5-3 3-4-4-6 6" stroke="#31D7CA" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>General Image</h3>
                        <p style="color: #7DA3AF; margin-top: 0.5rem;">Custom Creation</p>
                        <p style="color: #A9C1CB; font-size: 0.9rem; margin-top: 0.5rem;">
                            2 Variations (9:16 Portrait)
                        </p>
                    </div>
                </div>

                <button class="btn-primary" id="continueBtn" onclick="nextStep()" disabled>
                    Continue to Inspiration ‚Üí
                </button>
            </div>
        </div>

        <!-- Past Projects Panel (Separate Card) - Only visible on Step 1 -->
        <div id="pastProjectsPanel" class="card" style="margin-top: 2rem; background: #466F88; padding: 2.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="margin: 0; color: white;">Past Projects</h2>
                <div style="display: flex; gap: 0.5rem;">
                    <input type="text" id="projectSearch" placeholder="Search projects..."
                           style="padding: 0.5rem 1rem; border: none; border-radius: 6px; font-size: 0.9rem; width: 200px; background: rgba(255,255,255,0.9);">
                    <select id="projectFilter" style="padding: 0.5rem 1rem; border: none; border-radius: 6px; font-size: 0.9rem; background: rgba(255,255,255,0.9);">
                        <option value="all">All Platforms</option>
                        <option value="meta">Meta</option>
                        <option value="reddit">Reddit</option>
                        <option value="pinterest">Pinterest</option>
                        <option value="demandgen">Demand Gen</option>
                        <option value="pmax">Performance Max</option>
                        <option value="general">General Image</option>
                    </select>
                </div>
            </div>

            <!-- Project Grid (Mockup Data - 6 projects) -->
            <div id="pastProjectsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem;">

                <!-- Sample Project 1 -->
                <div class="past-project-card" onclick="loadProject('proj1')" style="border: 2px solid #E1E7EF; border-radius: 12px; overflow: hidden; cursor: pointer; transition: all 0.2s ease; background: white;" onmouseover="this.style.borderColor='#31D7CA'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(49,215,202,0.15)';" onmouseout="this.style.borderColor='#E1E7EF'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <div style="position: relative;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2px; background: #E1E7EF;">
                            <div style="aspect-ratio: 1; background: linear-gradient(135deg, #31D7CA 0%, #272D3F 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">üì±</div>
                            <div style="aspect-ratio: 1; background: linear-gradient(135deg, #FC883A 0%, #272D3F 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">üíç</div>
                        </div>
                        <div style="position: absolute; top: 0.5rem; right: 0.5rem; display: flex; gap: 0.25rem;">
                            <span style="background: #31D7CA; color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">Meta</span>
                            <span style="background: #E60023; color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">Pinterest</span>
                        </div>
                    </div>
                    <div style="padding: 1rem;">
                        <h4 style="margin: 0 0 0.25rem 0; color: #272D3F; font-size: 1rem;">Valentine's Day Campaign</h4>
                        <p style="margin: 0 0 0.5rem 0; color: #7DA3AF; font-size: 0.8rem;">Engagement ring protection for couples</p>
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: #A9C1CB;">
                            <span>üìÖ Jan 10, 2026</span>
                            <span>üë§ Sarah M.</span>
                        </div>
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
                            <span style="background: #F4F7FC; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; color: #7DA3AF;">12 ads</span>
                            <span style="background: #F4F7FC; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; color: #7DA3AF;">3 GIFs</span>
                        </div>
                    </div>
                </div>

                <!-- Sample Project 2 -->
                <div class="past-project-card" onclick="loadProject('proj2')" style="border: 2px solid #E1E7EF; border-radius: 12px; overflow: hidden; cursor: pointer; transition: all 0.2s ease; background: white;" onmouseover="this.style.borderColor='#31D7CA'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(49,215,202,0.15)';" onmouseout="this.style.borderColor='#E1E7EF'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <div style="position: relative;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2px; background: #E1E7EF;">
                            <div style="aspect-ratio: 1; background: linear-gradient(135deg, #FF4500 0%, #272D3F 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">üî¥</div>
                            <div style="aspect-ratio: 1; background: linear-gradient(135deg, #272D3F 0%, #31D7CA 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">‚ú®</div>
                        </div>
                        <div style="position: absolute; top: 0.5rem; right: 0.5rem; display: flex; gap: 0.25rem;">
                            <span style="background: #FF4500; color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">Reddit</span>
                        </div>
                    </div>
                    <div style="padding: 1rem;">
                        <h4 style="margin: 0 0 0.25rem 0; color: #272D3F; font-size: 1rem;">Reddit Q1 Push</h4>
                        <p style="margin: 0 0 0.5rem 0; color: #7DA3AF; font-size: 0.8rem;">Community-focused jewelry insurance</p>
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: #A9C1CB;">
                            <span>üìÖ Jan 5, 2026</span>
                            <span>üë§ Mike T.</span>
                        </div>
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
                            <span style="background: #F4F7FC; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; color: #7DA3AF;">6 ads</span>
                            <span style="background: #F4F7FC; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; color: #7DA3AF;">2 GIFs</span>
                        </div>
                    </div>
                </div>

                <!-- Sample Project 3 -->
                <div class="past-project-card" onclick="loadProject('proj3')" style="border: 2px solid #E1E7EF; border-radius: 12px; overflow: hidden; cursor: pointer; transition: all 0.2s ease; background: white;" onmouseover="this.style.borderColor='#31D7CA'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(49,215,202,0.15)';" onmouseout="this.style.borderColor='#E1E7EF'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <div style="position: relative;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2px; background: #E1E7EF;">
                            <div style="aspect-ratio: 1; background: linear-gradient(135deg, #31D7CA 0%, #FC883A 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">üíé</div>
                            <div style="aspect-ratio: 1; background: linear-gradient(135deg, #E60023 0%, #272D3F 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">üìå</div>
                        </div>
                        <div style="position: absolute; top: 0.5rem; right: 0.5rem; display: flex; gap: 0.25rem;">
                            <span style="background: #31D7CA; color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">Meta</span>
                            <span style="background: #E60023; color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">Pinterest</span>
                            <span style="background: #FF4500; color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">Reddit</span>
                        </div>
                    </div>
                    <div style="padding: 1rem;">
                        <h4 style="margin: 0 0 0.25rem 0; color: #272D3F; font-size: 1rem;">Holiday 2025 Campaign</h4>
                        <p style="margin: 0 0 0.5rem 0; color: #7DA3AF; font-size: 0.8rem;">Full multi-platform holiday push</p>
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: #A9C1CB;">
                            <span>üìÖ Dec 15, 2025</span>
                            <span>üë§ Sarah M.</span>
                        </div>
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
                            <span style="background: #F4F7FC; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; color: #7DA3AF;">18 ads</span>
                            <span style="background: #F4F7FC; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; color: #7DA3AF;">5 GIFs</span>
                        </div>
                    </div>
                </div>

                <!-- Sample Project 4 -->
                <div class="past-project-card" onclick="loadProject('proj4')" style="border: 2px solid #E1E7EF; border-radius: 12px; overflow: hidden; cursor: pointer; transition: all 0.2s ease; background: white;" onmouseover="this.style.borderColor='#31D7CA'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(49,215,202,0.15)';" onmouseout="this.style.borderColor='#E1E7EF'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <div style="position: relative;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2px; background: #E1E7EF;">
                            <div style="aspect-ratio: 1; background: linear-gradient(135deg, #272D3F 0%, #31D7CA 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">üë∞</div>
                            <div style="aspect-ratio: 1; background: linear-gradient(135deg, #FC883A 0%, #31D7CA 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">ü§µ</div>
                        </div>
                        <div style="position: absolute; top: 0.5rem; right: 0.5rem; display: flex; gap: 0.25rem;">
                            <span style="background: #31D7CA; color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">Meta</span>
                        </div>
                    </div>
                    <div style="padding: 1rem;">
                        <h4 style="margin: 0 0 0.25rem 0; color: #272D3F; font-size: 1rem;">Wedding Season 2025</h4>
                        <p style="margin: 0 0 0.5rem 0; color: #7DA3AF; font-size: 0.8rem;">Summer wedding jewelry protection</p>
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: #A9C1CB;">
                            <span>üìÖ Nov 28, 2025</span>
                            <span>üë§ Alex R.</span>
                        </div>
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
                            <span style="background: #F4F7FC; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; color: #7DA3AF;">8 ads</span>
                            <span style="background: #F4F7FC; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; color: #7DA3AF;">2 GIFs</span>
                        </div>
                    </div>
                </div>

                <!-- Sample Project 5 -->
                <div class="past-project-card" onclick="loadProject('proj5')" style="border: 2px solid #E1E7EF; border-radius: 12px; overflow: hidden; cursor: pointer; transition: all 0.2s ease; background: white;" onmouseover="this.style.borderColor='#31D7CA'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(49,215,202,0.15)';" onmouseout="this.style.borderColor='#E1E7EF'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <div style="position: relative;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2px; background: #E1E7EF;">
                            <div style="aspect-ratio: 1; background: linear-gradient(135deg, #E60023 0%, #FC883A 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">üíê</div>
                            <div style="aspect-ratio: 1; background: linear-gradient(135deg, #31D7CA 0%, #272D3F 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">üíù</div>
                        </div>
                        <div style="position: absolute; top: 0.5rem; right: 0.5rem; display: flex; gap: 0.25rem;">
                            <span style="background: #E60023; color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">Pinterest</span>
                        </div>
                    </div>
                    <div style="padding: 1rem;">
                        <h4 style="margin: 0 0 0.25rem 0; color: #272D3F; font-size: 1rem;">Mother's Day Special</h4>
                        <p style="margin: 0 0 0.5rem 0; color: #7DA3AF; font-size: 0.8rem;">Family heirloom protection campaign</p>
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: #A9C1CB;">
                            <span>üìÖ Nov 15, 2025</span>
                            <span>üë§ Lisa K.</span>
                        </div>
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
                            <span style="background: #F4F7FC; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; color: #7DA3AF;">10 ads</span>
                            <span style="background: #F4F7FC; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; color: #7DA3AF;">4 GIFs</span>
                        </div>
                    </div>
                </div>

                <!-- Sample Project 6 -->
                <div class="past-project-card" onclick="loadProject('proj6')" style="border: 2px solid #E1E7EF; border-radius: 12px; overflow: hidden; cursor: pointer; transition: all 0.2s ease; background: white;" onmouseover="this.style.borderColor='#31D7CA'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(49,215,202,0.15)';" onmouseout="this.style.borderColor='#E1E7EF'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <div style="position: relative;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2px; background: #E1E7EF;">
                            <div style="aspect-ratio: 1; background: linear-gradient(135deg, #272D3F 0%, #FF4500 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">üéÑ</div>
                            <div style="aspect-ratio: 1; background: linear-gradient(135deg, #FC883A 0%, #E60023 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">üéÅ</div>
                        </div>
                        <div style="position: absolute; top: 0.5rem; right: 0.5rem; display: flex; gap: 0.25rem;">
                            <span style="background: #31D7CA; color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">Meta</span>
                            <span style="background: #FF4500; color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">Reddit</span>
                        </div>
                    </div>
                    <div style="padding: 1rem;">
                        <h4 style="margin: 0 0 0.25rem 0; color: #272D3F; font-size: 1rem;">Black Friday Promo</h4>
                        <p style="margin: 0 0 0.5rem 0; color: #7DA3AF; font-size: 0.8rem;">Limited time insurance deals</p>
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: #A9C1CB;">
                            <span>üìÖ Nov 1, 2025</span>
                            <span>üë§ Mike T.</span>
                        </div>
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
                            <span style="background: #F4F7FC; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; color: #7DA3AF;">14 ads</span>
                            <span style="background: #F4F7FC; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; color: #7DA3AF;">6 GIFs</span>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Empty State (hidden by default, shown when no projects) -->
            <div id="emptyProjectsState" style="display: none; text-align: center; padding: 3rem; background: rgba(255,255,255,0.1); border-radius: 12px;">
                <p style="font-size: 3rem; margin-bottom: 1rem;">üìÇ</p>
                <h3 style="color: white; margin-bottom: 0.5rem;">No past projects yet</h3>
                <p style="color: rgba(255,255,255,0.7);">Projects you create will appear here for easy access and editing.</p>
            </div>

            <!-- Load More Button -->
            <div style="text-align: center; margin-top: 2rem;">
                <button onclick="loadMoreProjects()" style="padding: 0.75rem 2rem; background: #31D7CA; color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;">
                    Load More Projects
                </button>
            </div>
        </div>

        <!-- Step 2: Inspiration Input -->
        <div id="step2" class="card hidden">
            <h1>Add Your Inspiration</h1>
            <p style="color: #7DA3AF; font-size: 1.1rem; margin-bottom: 2rem;">
                Tell us about your campaign or upload inspiration images. You can do one or both!
            </p>

            <h2>Campaign Concept</h2>
            <textarea id="campaignText" placeholder="Describe your campaign idea, key messages, themes, or any text you want incorporated...

Example: Valentine's Day campaign for engagement ring insurance. Focus on celebrating love and protecting what matters most. Target newly engaged couples."
                      oninput="updateCharCount()" maxlength="500"></textarea>
            <div class="char-count" id="charCount">0 / 500 characters</div>

            <h2 style="margin-top: 2rem;">Inspiration Images (Optional)</h2>
            <div class="image-upload-area" onclick="document.getElementById('fileInput').click()">
                <p style="font-size: 3rem; margin-bottom: 1rem;">üì∏</p>
                <p style="font-weight: 600; font-size: 1.2rem; margin-bottom: 0.5rem;">Upload Inspiration Images</p>
                <p style="color: #A9C1CB;">Click to browse or drag and drop</p>
                <input type="file" id="fileInput" multiple accept="image/*" style="display: none;" onchange="handleFiles(this.files)">
            </div>
            <div id="imagePreview" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; margin-top: 1rem;"></div>

            <h2 style="margin-top: 2rem;">AI Provider</h2>
            <div style="margin-bottom: 2rem;">
                <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Choose AI provider for prompt generation:</label>
                <select id="aiProviderStep2" style="padding: 0.75rem; border: 2px solid #E1E7EF; border-radius: 8px; font-size: 1rem; width: 100%;">
                    <option value="claude">Claude (Anthropic) - Recommended</option>
                    <option value="openai">OpenAI (GPT-4)</option>
                </select>
            </div>

            <div class="button-group">
                <button class="btn-secondary" onclick="prevStep()">‚Üê Back</button>
                <button class="btn-primary" onclick="generateAds()">Generate Image Prompts ‚Üí</button>
            </div>
        </div>

        <!-- Step 3: Generation -->
        <div id="step3" class="card hidden">
            <h1>üé® Generating Your Ads...</h1>

            <!-- AI Provider Selection -->
            <div style="margin-bottom: 2rem;">
                <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Choose AI Provider for Prompts:</label>
                <select id="aiProvider" style="padding: 0.5rem; border: 2px solid #E1E7EF; border-radius: 8px; font-size: 1rem;">
                    <option value="claude">Claude (Anthropic) - Recommended</option>
                    <option value="openai">OpenAI (GPT-4)</option>
                </select>
            </div>

            <!-- Loading State -->
            <div id="loadingState" style="background: #F4F7FC; padding: 3rem; border-radius: 12px; margin: 2rem 0; text-align: center;">
                <p style="font-size: 3rem; margin-bottom: 1rem;">‚ú®</p>
                <p style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem;" id="loadingText">Click Generate to start</p>
                <p style="color: #7DA3AF; font-size: 1.1rem;" id="loadingStatus">Ready to create your ads</p>
            </div>

            <!-- Generated Prompt - Editable -->
            <div id="generatedPromptSection" class="hidden" style="background: #F4F7FC; padding: 2rem; border-radius: 12px; margin: 2rem 0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="margin: 0;">Generated Prompt (You can edit this):</h3>
                    <div id="inspirationStatusBadge" style="display: none;"></div>
                </div>
                <textarea id="promptText" style="width: 100%; min-height: 200px; padding: 1rem; border: 2px solid #E1E7EF; border-radius: 8px; font-size: 1rem; line-height: 1.6; font-family: inherit;"></textarea>
                <p style="color: #7DA3AF; margin-top: 0.5rem; font-size: 0.9rem;">‚úèÔ∏è Edit the prompt above if you want to adjust the image style</p>
            </div>

            <div class="button-group">
                <button class="btn-secondary" onclick="prevStep()">‚Üê Back</button>
                <button class="btn-primary" id="generatePromptBtn" onclick="generatePromptOnly()">Generate Prompt ‚Üí</button>
                <button class="btn-secondary hidden" id="regeneratePromptBtn" onclick="regeneratePrompt()">üîÑ Regenerate Prompt</button>
                <button class="btn-primary hidden" id="generateImagesBtn" onclick="generateImagesFromPrompt()">Generate Images ‚Üí</button>
            </div>
        </div>

        <!-- Step 4: Generated Images Preview -->
        <div id="step4" class="card hidden">
            <h1>‚ú® Your Images Are Ready!</h1>
            <p style="color: #7DA3AF; font-size: 1.1rem; margin-bottom: 2rem;">
                Preview your AI-generated images below. Next, we'll add text overlays for each platform.
            </p>

            <div id="imagesGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 2rem;"></div>

            <div class="button-group" style="margin-top: 2rem;">
                <button class="btn-secondary" onclick="backToPromptEdit()">‚Üê Edit Prompt</button>
                <button class="btn-secondary" onclick="regenerateImagesFromStep4()">üîÑ Regenerate Images</button>
                <button class="btn-primary" onclick="goToTextOverlay()">Add Text Overlays ‚Üí</button>
            </div>
        </div>

        <!-- Step 5: Text Overlay Customization -->
        <div id="step5" class="card hidden">
            <h1>‚úèÔ∏è Customize Text Overlays</h1>
            <p style="color: #7DA3AF; font-size: 1.1rem; margin-bottom: 2rem;">
                Add custom headlines and text to each ad. Customize the font, size, color, and background for each platform.
            </p>

            <div id="textOverlayGrid" style="display: grid; grid-template-columns: 1fr; gap: 2rem;"></div>

            <div class="button-group" style="margin-top: 2rem;">
                <button class="btn-secondary" onclick="backToImagePreview()">‚Üê Back to Images</button>
                <button class="btn-primary" onclick="goToLogoPlacement()">Add Logos ‚Üí</button>
            </div>
        </div>

        <!-- Step 6: Logo Placement -->
        <div id="step6" class="card hidden">
            <h1>üè¢ Add Your Logo</h1>
            <p style="color: #7DA3AF; font-size: 1.1rem; margin-bottom: 2rem;">
                Position and size your logo on each ad.
            </p>

            <div id="logoGrid" style="display: grid; grid-template-columns: 1fr; gap: 2rem;"></div>

            <div class="button-group" style="margin-top: 2rem;">
                <button class="btn-secondary" onclick="backToTextOverlay()">‚Üê Back to Text</button>
                <button class="btn-secondary" onclick="goToPreviewSkipCopy()" id="skipCopyBtn" style="display: none;">Preview & Download</button>
                <button class="btn-primary" onclick="goToNextAfterLogo()" id="afterLogoBtn">Generate Ad Copy ‚Üí</button>
            </div>
        </div>

        <!-- Step 7: Ad Copy Generation -->
        <div id="step7" class="card hidden">
            <h1>‚úçÔ∏è Generate Ad Copy</h1>
            <p style="color: #7DA3AF; font-size: 1.1rem; margin-bottom: 2rem;">
                AI-generated ad copy with 3 variations for each component. Select your favorites and edit as needed.
            </p>

            <div id="adCopyGrid" style="display: grid; grid-template-columns: 1fr; gap: 2rem;"></div>

            <div class="button-group" style="margin-top: 2rem;">
                <button class="btn-secondary" onclick="backToLogoPlacement()">‚Üê Back to Logos</button>
                <button class="btn-secondary" onclick="regenerateAllAdCopy()" id="regenerateAllCopyBtn">üîÑ Regenerate All Copy</button>
                <button class="btn-secondary" onclick="exportAllCopyOptions()">üìã Export All Copy Options</button>
                <button class="btn-primary" onclick="goToFinalReview()">Review & Download ‚Üí</button>
            </div>
        </div>

        <!-- Step 8: Final Review -->
        <div id="step8" class="card hidden">
            <h1>üéâ Final Review</h1>
            <p style="color: #7DA3AF; font-size: 1.1rem; margin-bottom: 2rem;">
                Review your completed ads with images and copy. Download individual ads or export all copy.
            </p>

            <div id="finalReviewGrid" style="display: grid; grid-template-columns: 1fr; gap: 2rem;"></div>

            <div class="button-group" style="margin-top: 2rem;">
                <button class="btn-secondary" onclick="backToAdCopy()">‚Üê Back to Ad Copy</button>
                <button class="btn-secondary" onclick="exportAllCopy()">üìã Export Selected Copy</button>
                <button class="btn-secondary" onclick="exportAllCopyOptions()">üìã Export All Copy Options</button>
                <button class="btn-primary" onclick="downloadAll()">üì• Download All Ads</button>
            </div>

            <div style="margin-top: 3rem; padding: 3rem 2rem; background: linear-gradient(135deg, #31D7CA 0%, #272D3F 100%); border-radius: 16px; text-align: center; box-shadow: 0 8px 24px rgba(49, 215, 202, 0.2);">
                <h3 style="color: white; margin-bottom: 0.75rem; font-size: 1.75rem; font-weight: 700;">üé¨ Want Animated Versions?</h3>
                <p style="color: rgba(255,255,255,0.95); margin-bottom: 2rem; font-size: 1.1rem; max-width: 600px; margin-left: auto; margin-right: auto;">Create eye-catching animated GIFs from your ads to boost engagement</p>
                <button class="btn-primary" onclick="goToGifCreation()" style="background: white; color: #272D3F; border: none; padding: 1rem 2.5rem; font-size: 1.1rem; font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'">
                    Create Animated GIFs ‚Üí
                </button>
            </div>
        </div>

        <!-- Step 9: General Image Preview (for General Image platform only) -->
        <div id="stepGeneralPreview" class="card hidden">
            <h1>Preview & Download</h1>
            <p style="color: #7DA3AF; font-size: 1.1rem; margin-bottom: 2rem;">
                Your images are ready! Download them or create animated versions.
            </p>

            <div id="generalPreviewGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 2rem; margin-bottom: 2rem;"></div>

            <div class="button-group" style="margin-top: 2rem;">
                <button class="btn-secondary" onclick="backToLogoFromGeneral()">‚Üê Back to Logos</button>
                <button class="btn-secondary" onclick="downloadAllGeneralImages()">Download All Images</button>
                <button class="btn-primary" onclick="goToGifFromGeneral()">Create Animated GIFs ‚Üí</button>
            </div>
        </div>

        <!-- Preview & Download (Skip Copy option for Meta/Reddit/Pinterest) -->
        <div id="stepPreview" class="card hidden">
            <h1>Preview & Download</h1>
            <p style="color: #7DA3AF; font-size: 1.1rem; margin-bottom: 2rem;">
                Your images are ready! Download them, create animated versions, or go back to add ad copy.
            </p>

            <div id="previewGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 2rem; margin-bottom: 2rem;"></div>

            <div class="button-group" style="margin-top: 2rem;">
                <button class="btn-secondary" onclick="backToLogoFromPreview()">‚Üê Back to Logos</button>
                <button class="btn-secondary" onclick="downloadAllPreviewImages()">Download All Images</button>
                <button class="btn-primary" onclick="goToGifFromPreview()">Create Animated GIFs ‚Üí</button>
            </div>

            <div style="margin-top: 2rem; padding: 1.5rem; background: #F4F7FC; border-radius: 12px; text-align: center;">
                <p style="color: #7DA3AF; margin-bottom: 1rem;">Want to add ad copy (headlines, body text, CTAs)?</p>
                <button class="btn-secondary" onclick="goToAdCopyFromPreview()" style="background: #31D7CA; color: white; border: none;">
                    ‚úçÔ∏è Generate Ad Copy
                </button>
            </div>
        </div>

        <!-- Step 10: GIF Creation -->
        <div id="step9" class="card hidden">
            <h1>üé¨ Create Animated GIFs</h1>
            <p style="color: #7DA3AF; font-size: 1.1rem; margin-bottom: 2rem;">Select ads to animate and customize frames</p>

            <div id="gifSelectionGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;"></div>

            <div class="button-group" style="margin-top: 2rem;">
                <button class="btn-secondary" onclick="backToFinalReview()" id="backFromGifBtn">‚Üê Back to Review</button>
                <button class="btn-primary" onclick="generateSelectedGifs()" id="generate-gifs-btn">‚ú® Generate Selected GIFs</button>
            </div>
        </div>

        <!-- Step 10: GIF Results -->
        <div id="step10" class="card hidden">
            <h1>üé¨ Generated Animations</h1>
            <p style="color: #7DA3AF; font-size: 1.1rem; margin-bottom: 2rem;">Your animated GIFs are ready! Edit frames or download.</p>

            <div id="gifResultsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 2rem; margin-bottom: 2rem;"></div>

            <div class="button-group" style="margin-top: 2rem;">
                <button class="btn-secondary" onclick="backToGifSelection()">‚Üê Back to Selection</button>
                <button class="btn-secondary" onclick="backToFinalReview()">‚Üê Back to All Ads</button>
                <button class="btn-secondary" onclick="startOver()" style="background: #FC883A; color: white; border: none;">üîÑ Start Over</button>
            </div>
        </div>
    </main>

    <!-- Frame Editor Modal -->
    <div id="frameEditorModal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; overflow-y: auto;">
        <div style="max-width: 1200px; margin: 2rem auto; background: white; border-radius: 16px; padding: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2 style="color: #272D3F; margin: 0;">‚úèÔ∏è Edit GIF Frames</h2>
                <button onclick="closeFrameEditor()" class="btn-secondary">‚úï Close</button>
            </div>

            <div id="frameEditorContent" style="display: grid; grid-template-columns: 1fr 350px; gap: 2rem;">
                <!-- Left: Frame Preview -->
                <div>
                    <div style="position: relative; background: #F4F7FC; border-radius: 12px; padding: 1rem; margin-bottom: 1rem;">
                        <canvas id="framePreviewCanvas" style="width: 100%; border-radius: 8px; display: block;"></canvas>
                    </div>

                    <!-- Frame Thumbnails -->
                    <div style="margin-top: 1rem;">
                        <h4 style="color: #272D3F; margin-bottom: 0.75rem;">Select Frame:</h4>
                        <div id="frameThumbnails" style="display: flex; gap: 0.5rem; overflow-x: auto; padding-bottom: 0.5rem;"></div>
                    </div>
                </div>

                <!-- Right: Text Overlay Controls -->
                <div style="background: #F4F7FC; border-radius: 12px; padding: 1.5rem;">
                    <h4 style="color: #272D3F; margin-bottom: 1rem;">Text Overlay</h4>

                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; font-size: 0.9rem; color: #7DA3AF; margin-bottom: 0.5rem;">Text:</label>
                        <input type="text" id="frameTextInput"
                               placeholder="Enter text for this frame"
                               oninput="updateFramePreview()"
                               style="width: 100%; padding: 0.75rem; border: 1px solid #E1E7EF; border-radius: 8px; font-size: 1rem;">
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; font-size: 0.9rem; color: #7DA3AF; margin-bottom: 0.5rem;">Position:</label>
                        <select id="framePositionSelect" onchange="updateFramePreview()"
                                style="width: 100%; padding: 0.75rem; border: 1px solid #E1E7EF; border-radius: 8px;">
                            <option value="top">Top</option>
                            <option value="center">Center</option>
                            <option value="bottom" selected>Bottom</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; font-size: 0.9rem; color: #7DA3AF; margin-bottom: 0.5rem;">Font Family:</label>
                        <select id="frameFontSelect" onchange="updateFramePreview()"
                                style="width: 100%; padding: 0.75rem; border: 1px solid #E1E7EF; border-radius: 8px;">
                            <option value="Gilroy, Arial, sans-serif" selected>Gilroy (Default)</option>
                            <option value="Arial, sans-serif">Arial</option>
                            <option value="'Helvetica Neue', Helvetica, sans-serif">Helvetica</option>
                            <option value="Georgia, serif">Georgia</option>
                            <option value="'Times New Roman', Times, serif">Times New Roman</option>
                            <option value="'Courier New', Courier, monospace">Courier</option>
                            <option value="Impact, sans-serif">Impact</option>
                            <option value="'Comic Sans MS', cursive">Comic Sans</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; font-size: 0.9rem; color: #7DA3AF; margin-bottom: 0.5rem;">Font Size: <span id="frameSizeDisplay">32</span>px</label>
                        <input type="range" id="frameSizeSlider" min="16" max="72" value="32"
                               oninput="document.getElementById('frameSizeDisplay').textContent = this.value; updateFramePreview()"
                               style="width: 100%;">
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; font-size: 0.9rem; color: #7DA3AF; margin-bottom: 0.5rem;">Text Color:</label>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem;">
                            <button onclick="setFrameColor('#FFFFFF')" style="background: #FFFFFF; border: 2px solid #E1E7EF; border-radius: 6px; padding: 0.5rem; cursor: pointer;">White</button>
                            <button onclick="setFrameColor('#31D7CA')" style="background: #31D7CA; border: 2px solid #31D7CA; border-radius: 6px; padding: 0.5rem; cursor: pointer; color: white;">Turquoise</button>
                            <button onclick="setFrameColor('#FC883A')" style="background: #FC883A; border: 2px solid #FC883A; border-radius: 6px; padding: 0.5rem; cursor: pointer; color: white;">Orange</button>
                            <button onclick="setFrameColor('#272D3F')" style="background: #272D3F; border: 2px solid #272D3F; border-radius: 6px; padding: 0.5rem; cursor: pointer; color: white;">Navy</button>
                            <button onclick="setFrameColor('#000000')" style="background: #000000; border: 2px solid #000000; border-radius: 6px; padding: 0.5rem; cursor: pointer; color: white;">Black</button>
                            <button onclick="setFrameColor('#FFD700')" style="background: #FFD700; border: 2px solid #FFD700; border-radius: 6px; padding: 0.5rem; cursor: pointer;">Gold</button>
                        </div>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; font-size: 0.9rem; color: #7DA3AF; margin-bottom: 0.5rem;">Background Color:</label>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem;">
                            <button onclick="setFrameBgColor('rgba(0,0,0,0.7)')" style="background: rgba(0,0,0,0.7); border: 2px solid #E1E7EF; border-radius: 6px; padding: 0.5rem; cursor: pointer; color: white;">Dark</button>
                            <button onclick="setFrameBgColor('rgba(0,0,0,0.5)')" style="background: rgba(0,0,0,0.5); border: 2px solid #E1E7EF; border-radius: 6px; padding: 0.5rem; cursor: pointer; color: white;">Medium</button>
                            <button onclick="setFrameBgColor('rgba(0,0,0,0.3)')" style="background: rgba(0,0,0,0.3); border: 2px solid #E1E7EF; border-radius: 6px; padding: 0.5rem; cursor: pointer; color: white;">Light</button>
                            <button onclick="setFrameBgColor('rgba(49,215,202,0.8)')" style="background: rgba(49,215,202,0.8); border: 2px solid #31D7CA; border-radius: 6px; padding: 0.5rem; cursor: pointer; color: white;">Turquoise</button>
                            <button onclick="setFrameBgColor('rgba(252,136,58,0.8)')" style="background: rgba(252,136,58,0.8); border: 2px solid #FC883A; border-radius: 6px; padding: 0.5rem; cursor: pointer; color: white;">Orange</button>
                            <button onclick="setFrameBgColor('rgba(255,255,255,0.9)')" style="background: rgba(255,255,255,0.9); border: 2px solid #E1E7EF; border-radius: 6px; padding: 0.5rem; cursor: pointer;">White</button>
                        </div>
                    </div>

                    <div style="margin-bottom: 1rem; padding: 1rem; background: #F4F7FC; border-radius: 8px;">
                        <label style="display: flex; align-items: center; font-size: 1.1rem; font-weight: 600; color: #272D3F; cursor: pointer;">
                            <input type="checkbox" id="frameLogoCheckbox" onchange="toggleFrameLogo()"
                                   style="width: 20px; height: 20px; margin-right: 0.75rem; cursor: pointer; accent-color: #31D7CA;">
                            üè∑Ô∏è Add Logo
                        </label>
                        <div id="frameLogoControls" style="display: none; padding-top: 1rem;">
                            <label style="display: block; font-size: 0.85rem; color: #7DA3AF; margin-bottom: 0.5rem;">Select Logo:</label>
                            <div id="frameLogoSelector" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-bottom: 1rem;"></div>

                            <label style="display: block; font-size: 0.85rem; color: #7DA3AF; margin-bottom: 0.25rem;">Logo Size: <span id="frameLogoSizeDisplay">15</span>%</label>
                            <input type="range" id="frameLogoSize" min="8" max="30" value="15"
                                   oninput="document.getElementById('frameLogoSizeDisplay').textContent = this.value; updateFramePreview()"
                                   style="width: 100%; margin-bottom: 0.75rem;">

                            <p style="font-size: 0.8rem; color: #31D7CA; margin-top: 0.5rem;">üí° Click and drag the logo on the preview to position it</p>
                        </div>
                    </div>

                    <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #E1E7EF;">
                        <button onclick="applyToAllFrames()" class="btn-secondary" style="width: 100%; margin-bottom: 0.5rem;">
                            üìã Apply to All Frames
                        </button>
                        <button onclick="clearFrameOverlay()" class="btn-secondary" style="width: 100%; margin-bottom: 0.5rem;">
                            üóëÔ∏è Clear This Frame
                        </button>
                        <button onclick="deleteCurrentFrame()" class="btn-secondary" style="width: 100%; background: #D73D4F; color: white; border: none;">
                            ‚ùå Delete This Frame
                        </button>
                    </div>
                </div>
            </div>

            <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid #E1E7EF;">
                <!-- Animation Speed Control -->
                <div style="max-width: 400px; margin: 0 auto 1.5rem auto; text-align: left;">
                    <label style="display: block; font-size: 1rem; font-weight: 600; color: #272D3F; margin-bottom: 0.5rem;">
                        Animation Speed: <span id="animationSpeedDisplay">2</span> FPS
                    </label>
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <span style="font-size: 0.85rem; color: #7DA3AF;">Slow</span>
                        <input type="range" id="animationSpeedSlider" min="1" max="5" value="2" step="1"
                               oninput="updateAnimationSpeed(this.value)"
                               style="flex: 1;">
                        <span style="font-size: 0.85rem; color: #7DA3AF;">Fast</span>
                    </div>
                    <p id="animationDurationDisplay" style="font-size: 0.8rem; color: #31D7CA; margin-top: 0.5rem; text-align: center;"></p>
                </div>

                <div style="text-align: center;">
                    <button onclick="regenerateGifWithOverlays()" class="btn-primary" style="padding: 1rem 2rem; font-size: 1.1rem;">
                        ‚ú® Regenerate GIF with Text Overlays
                    </button>
                    <p style="color: #7DA3AF; font-size: 0.85rem; margin-top: 0.5rem;">This will create a new GIF with your text overlays applied</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <h2 style="color: #272D3F; margin-bottom: 1rem;" id="overlayTitle">Generating Images</h2>
            <p style="color: #7DA3AF; font-size: 1.1rem; line-height: 1.6;" id="overlayMessage">
                This may take a minute. Google Gemini is creating your custom ad images.
            </p>
        </div>
    </div>

    <footer>
        <p>¬© 2026 BriteCo. Internal use only.</p>
        <p style="margin-top: 0.5rem;">Powered by Claude AI, OpenAI, and Nano Banana</p>
    </footer>

    <script>
        let selectedPlatforms = new Set();
        let uploadedImages = [];

        // Available logos
        const availableLogos = [
            { name: 'BriteCo Logo 1', url: '/Logo-BriteCo-Solid-Color-01.png' },
            { name: 'BriteCo Logo 2', url: '/Logo-BriteCo-Solid-Color-02.png' },
            { name: 'BriteCo Logo 3', url: '/Logo-BriteCo-Solid-Color-03.png' },
            { name: 'BriteCo Logo 4', url: '/Logo-BriteCo-Solid-Color-04.png' },
            { name: 'Emblem 1', url: '/Emblem-01.png' },
            { name: 'Emblem 2', url: '/Emblem-02.png' },
            { name: 'White & Teal', url: '/White and Teal-Jewelry-Watch-Insurance-RGB.png' },
            { name: 'Blue & Teal', url: '/Blue and Teal-Jewelry-Watch-Insurance-RGB.png' },
            { name: 'Blue & White', url: '/Blue and white-Jewelry-Watch-Insurance-RGB.png' },
            { name: 'Blue RGB', url: '/Blue-Jewelry-Watch-Insurance-RGB.png' }
        ];

        // Pre-loaded BriteCo logo - loaded from file (deprecated, using availableLogos now)
        let uploadedLogo = null;
        let currentStep = 1;
        let skippedCopyFlow = false; // Track if user skipped the ad copy step
        let generatedImages = []; // Store generated images for use across steps
        let textOverlays = {}; // Store text overlay settings for each image
        let logoSettings = {}; // Store logo position (x, y), scale, and selectedLogoIndex for each image

        // Helper function to capitalize platform names for display
        function capitalizePlatform(platform) {
            const platformMap = {
                'meta': 'Meta',
                'reddit': 'Reddit',
                'pinterest': 'Pinterest',
                'demandgen': 'Demand Gen',
                'pmax': 'Performance Max',
                'general': 'General Image'
            };
            return platformMap[platform.toLowerCase()] || platform;
        }

        // Check if only General Image is selected (skip text generation)
        function isGeneralImageOnly() {
            return selectedPlatforms.size === 1 && selectedPlatforms.has('general');
        }

        // Check if only Google Ads platforms are selected (skip copy generation)
        function isGoogleAdsOnly() {
            const googleAdsPlatforms = ['demandgen', 'pmax'];
            const allGoogleAds = Array.from(selectedPlatforms).every(p => googleAdsPlatforms.includes(p));
            return selectedPlatforms.size > 0 && allGoogleAds;
        }

        // Check if any platform should skip copy generation
        function shouldSkipCopyGeneration() {
            return isGeneralImageOnly() || isGoogleAdsOnly();
        }

        function togglePlatform(platform, element) {
            if (selectedPlatforms.has(platform)) {
                selectedPlatforms.delete(platform);
                element.classList.remove('selected');
            } else {
                selectedPlatforms.add(platform);
                element.classList.add('selected');
            }

            updateSelectedCount();
        }

        function updateSelectedCount() {
            const count = selectedPlatforms.size;
            const btn = document.getElementById('continueBtn');

            if (count > 0) {
                btn.disabled = false;
            } else {
                btn.disabled = true;
            }
        }

        function nextStep() {
            if (selectedPlatforms.size === 0) {
                alert('Please select at least one platform!');
                return;
            }

            document.getElementById('step1').classList.add('hidden');
            document.getElementById('pastProjectsPanel').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
            currentStep = 2;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function prevStep() {
            if (currentStep === 2) {
                document.getElementById('step2').classList.add('hidden');
                document.getElementById('step1').classList.remove('hidden');
                document.getElementById('pastProjectsPanel').classList.remove('hidden');
                currentStep = 1;
            } else if (currentStep === 3) {
                document.getElementById('step3').classList.add('hidden');
                document.getElementById('step2').classList.remove('hidden');
                currentStep = 2;
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function generateAds() {
            const text = document.getElementById('campaignText').value;

            if (!text && uploadedImages.length === 0) {
                alert('Please add campaign text or upload images!');
                return;
            }

            // Get provider from Step 2 selector
            const provider = document.getElementById('aiProviderStep2').value;
            // Sync to Step 3 selector
            document.getElementById('aiProvider').value = provider;

            // Show loading overlay immediately
            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('loadingText').textContent = 'Generating image prompt...';

            // Navigate to Step 3 (but user sees loading overlay)
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.remove('hidden');
            currentStep = 3;
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // Start generating prompt
            generatePromptOnlyWithLoading();
        }

        // Step 1: Generate prompt only
        // Generate prompt with loading overlay (called from Step 2)
        async function generatePromptOnlyWithLoading() {
            const campaignText = document.getElementById('campaignText').value;
            const provider = document.getElementById('aiProvider').value;
            const platforms = Array.from(selectedPlatforms);

            try {
                // Update loading overlay status
                const providerName = provider === 'claude' ? 'Claude' : 'OpenAI';
                document.getElementById('overlayTitle').textContent = 'Generating Image Prompts';
                document.getElementById('overlayMessage').textContent = `This may take a minute. ${providerName} is creating your custom image prompts.`;
                document.getElementById('loadingText').textContent = 'Generating Image Prompts';
                document.getElementById('loadingStatus').textContent = `This may take a minute. ${providerName} is creating your custom image prompts.`;

                // If we have inspiration images, analyze them first
                let inspirationAnalysis = '';
                console.log('[INSPIRATION DEBUG] Checking uploadedImages array...');
                console.log('[INSPIRATION DEBUG] uploadedImages:', uploadedImages);
                console.log('[INSPIRATION DEBUG] uploadedImages.length:', uploadedImages.length);

                if (uploadedImages.length > 0) {
                    console.log('[INSPIRATION DEBUG] Found', uploadedImages.length, 'inspiration images to analyze');
                    console.log('[INSPIRATION DEBUG] Image names:', uploadedImages.map(img => img.name));
                    console.log('[INSPIRATION DEBUG] Image data lengths:', uploadedImages.map(img => img.data ? img.data.length : 0));

                    document.getElementById('overlayMessage').textContent = 'Analyzing inspiration images with Gemini Vision...';
                    document.getElementById('loadingStatus').textContent = 'Analyzing inspiration images with Gemini Vision...';

                    try {
                        const imagesToSend = uploadedImages.map(img => img.data);
                        console.log('[INSPIRATION DEBUG] Sending', imagesToSend.length, 'images to API');
                        console.log('[INSPIRATION DEBUG] First image data preview:', imagesToSend[0] ? imagesToSend[0].substring(0, 100) : 'no data');

                        const analysisResponse = await fetch('/api/analyze-inspiration-images', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                images: imagesToSend
                            })
                        });

                        const analysisResult = await analysisResponse.json();
                        console.log('[INSPIRATION DEBUG] Analysis API response status:', analysisResponse.status);
                        console.log('[INSPIRATION DEBUG] Analysis API response:', analysisResult);

                        if (analysisResult.success && analysisResult.analysis) {
                            inspirationAnalysis = analysisResult.analysis;
                            console.log('[INSPIRATION DEBUG] Inspiration analysis SUCCESS!');
                            console.log('[INSPIRATION DEBUG] Analysis text:', inspirationAnalysis);
                        } else if (analysisResult.error) {
                            console.error('[INSPIRATION DEBUG] Inspiration analysis FAILED:', analysisResult.error);
                            alert('Warning: Could not analyze inspiration images: ' + analysisResult.error);
                        } else {
                            console.warn('[INSPIRATION DEBUG] Analysis returned but no analysis text found');
                            console.warn('[INSPIRATION DEBUG] Full result:', JSON.stringify(analysisResult));
                        }
                    } catch (analysisError) {
                        console.error('[INSPIRATION DEBUG] Failed to analyze inspiration images:', analysisError);
                        alert('Warning: Could not analyze inspiration images. Check console for details.');
                    }

                    document.getElementById('overlayMessage').textContent = `${providerName} is creating your custom image prompts.`;
                    document.getElementById('loadingStatus').textContent = `${providerName} is creating your custom image prompts.`;
                } else {
                    console.log('[INSPIRATION DEBUG] No inspiration images found in uploadedImages array');
                }

                console.log('[INSPIRATION DEBUG] Final inspirationAnalysis being sent to generate-prompt:', inspirationAnalysis ? 'HAS CONTENT (' + inspirationAnalysis.length + ' chars)' : 'EMPTY');

                const response = await fetch('/api/generate-prompt', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        campaignText,
                        platforms,
                        provider,
                        inspirationAnalysis
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Show editable prompt
                    document.getElementById('promptText').value = result.prompt;
                    document.getElementById('generatedPromptSection').classList.remove('hidden');
                    document.getElementById('loadingState').style.display = 'none';

                    // Show inspiration status badge
                    const statusBadge = document.getElementById('inspirationStatusBadge');
                    if (statusBadge) {
                        if (inspirationAnalysis) {
                            statusBadge.innerHTML = `<span style="background: #31D7CA; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem;">‚úì Inspiration images analyzed (${uploadedImages.length} image${uploadedImages.length > 1 ? 's' : ''})</span>`;
                            statusBadge.style.display = 'block';
                        } else if (uploadedImages.length > 0) {
                            statusBadge.innerHTML = `<span style="background: #FC883A; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem;">‚ö† ${uploadedImages.length} image${uploadedImages.length > 1 ? 's' : ''} uploaded but analysis failed</span>`;
                            statusBadge.style.display = 'block';
                        } else {
                            statusBadge.innerHTML = `<span style="background: #A9C1CB; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem;">No inspiration images</span>`;
                            statusBadge.style.display = 'block';
                        }
                    }

                    // Hide prompt button, show images button and regenerate button
                    document.getElementById('generatePromptBtn').classList.add('hidden');
                    document.getElementById('generateImagesBtn').classList.remove('hidden');
                    document.getElementById('regeneratePromptBtn').classList.remove('hidden');

                    // Hide loading overlay - prompt is complete and displayed
                    document.getElementById('loadingOverlay').classList.add('hidden');
                } else {
                    alert('Failed to generate prompt: ' + result.error);
                    // Hide loading overlay on error
                    document.getElementById('loadingOverlay').classList.add('hidden');
                }
            } catch (error) {
                alert('Error: ' + error.message);
                // Hide loading overlay on error
                document.getElementById('loadingOverlay').classList.add('hidden');
            }
        }

        async function generatePromptOnly() {
            const campaignText = document.getElementById('campaignText').value;
            const provider = document.getElementById('aiProvider').value;
            const platforms = Array.from(selectedPlatforms);

            // Update UI
            document.getElementById('loadingText').textContent = 'Generating prompt...';
            document.getElementById('loadingStatus').textContent = 'Using AI to create an optimized image generation prompt';
            document.getElementById('generatePromptBtn').disabled = true;
            document.getElementById('generatePromptBtn').textContent = 'Generating...';

            try {
                // If we have inspiration images, analyze them first
                let inspirationAnalysis = '';
                if (uploadedImages.length > 0) {
                    document.getElementById('loadingStatus').textContent = 'Analyzing inspiration images...';

                    try {
                        const analysisResponse = await fetch('/api/analyze-inspiration-images', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                images: uploadedImages.map(img => img.data)
                            })
                        });

                        const analysisResult = await analysisResponse.json();
                        if (analysisResult.success && analysisResult.analysis) {
                            inspirationAnalysis = analysisResult.analysis;
                        }
                    } catch (analysisError) {
                        console.error('Failed to analyze inspiration images:', analysisError);
                    }

                    document.getElementById('loadingStatus').textContent = 'Creating image generation prompt...';
                }

                const response = await fetch('/api/generate-prompt', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        campaignText,
                        platforms,
                        provider,
                        inspirationAnalysis
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Show editable prompt
                    document.getElementById('promptText').value = result.prompt;
                    document.getElementById('generatedPromptSection').classList.remove('hidden');
                    document.getElementById('loadingState').style.display = 'none';

                    // Hide prompt button, show images button and regenerate button
                    document.getElementById('generatePromptBtn').classList.add('hidden');
                    document.getElementById('generateImagesBtn').classList.remove('hidden');
                    document.getElementById('regeneratePromptBtn').classList.remove('hidden');
                } else {
                    alert('Failed to generate prompt: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                document.getElementById('generatePromptBtn').disabled = false;
                document.getElementById('generatePromptBtn').textContent = 'Generate Prompt ‚Üí';
            }
        }

        // Regenerate prompt with new AI variation
        async function regeneratePrompt() {
            const campaignText = document.getElementById('campaignText').value;
            const provider = document.getElementById('aiProvider').value;
            const platforms = Array.from(selectedPlatforms);

            document.getElementById('regeneratePromptBtn').disabled = true;
            document.getElementById('regeneratePromptBtn').textContent = 'Regenerating...';

            try {
                const response = await fetch('/api/generate-prompt', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        campaignText,
                        platforms,
                        provider
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Replace prompt with new version
                    document.getElementById('promptText').value = result.prompt;
                } else {
                    alert('Failed to regenerate prompt: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                document.getElementById('regeneratePromptBtn').disabled = false;
                document.getElementById('regeneratePromptBtn').textContent = 'üîÑ Regenerate Prompt';
            }
        }

        // Step 2: Generate images from edited prompt
        async function generateImagesFromPrompt() {
            const prompt = document.getElementById('promptText').value;
            const platforms = Array.from(selectedPlatforms);
            const provider = document.getElementById('aiProvider').value;
            const providerName = provider === 'claude' ? 'Claude' : 'OpenAI';

            // Show loading overlay
            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('overlayTitle').textContent = 'Generating Images';
            document.getElementById('overlayMessage').textContent = `This may take a minute. Google Gemini is creating your custom ad images.`;

            document.getElementById('generateImagesBtn').disabled = true;
            document.getElementById('generateImagesBtn').textContent = 'Generating Images...';

            try {
                const response = await fetch('/api/generate-images', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        prompt,
                        platforms
                    })
                });

                const result = await response.json();

                if (result.success) {
                    console.log('Images received:', result.images.length);

                    // Store images globally
                    generatedImages = result.images;

                    // Show simple preview in Step 4
                    renderImagePreviews();

                    // Hide loading overlay
                    document.getElementById('loadingOverlay').classList.add('hidden');

                    // Go to step 4
                    document.getElementById('step3').classList.add('hidden');
                    document.getElementById('step4').classList.remove('hidden');
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                    alert('Failed to generate images: ' + result.error);
                }
            } catch (error) {
                document.getElementById('loadingOverlay').classList.add('hidden');
                alert('Error: ' + error.message);
            } finally {
                document.getElementById('generateImagesBtn').disabled = false;
                document.getElementById('generateImagesBtn').textContent = 'Generate Images ‚Üí';
            }
        }

        function renderImagePreviews() {
            const imagesGrid = document.getElementById('imagesGrid');
            imagesGrid.innerHTML = '';

            // Group images by base size
            const sizeGroups = {};
            generatedImages.forEach((img, index) => {
                const baseSizeName = img.size.replace(/\s*-\s*Variation\s+\d+/, '');
                if (!sizeGroups[baseSizeName]) {
                    sizeGroups[baseSizeName] = [];
                }
                sizeGroups[baseSizeName].push({ img, index });
            });

            // Render each size group
            Object.entries(sizeGroups).forEach(([baseSizeName, items]) => {
                // Create group header
                const groupHeader = document.createElement('div');
                groupHeader.style.cssText = 'grid-column: 1 / -1; margin-top: 1rem; margin-bottom: 0.5rem;';
                groupHeader.innerHTML = `<h3 style="color: #272D3F; font-size: 1.1rem; margin: 0;">${capitalizePlatform(items[0].img.platform)} - ${baseSizeName}</h3>`;
                imagesGrid.appendChild(groupHeader);

                // Render images in this group
                items.forEach(({ img, index }) => {
                    const card = document.createElement('div');
                    card.id = `image-card-${index}`;
                    card.style.cssText = 'border: 2px solid #E1E7EF; border-radius: 12px; padding: 1rem; background: white;';

                    const variationNumber = img.size.match(/Variation\s+(\d+)/)?.[1] || '';
                    card.innerHTML = `
                        <img id="image-preview-${index}" src="${img.url}" alt="${capitalizePlatform(img.platform)} ${img.size}"
                             style="width: 100%; max-width: 100%; border-radius: 8px; display: block; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <p style="color: #7DA3AF; font-size: 0.9rem; font-weight: 600; margin: 0;">Variation ${variationNumber}</p>
                                <p style="color: #A9C1CB; font-size: 0.85rem; margin: 0.25rem 0 0 0;">${img.width}x${img.height}</p>
                            </div>
                            <button onclick="regenerateSingleImage(${index})" id="regen-btn-${index}"
                                    style="padding: 0.5rem 1rem; border: 2px solid #31D7CA; border-radius: 6px;
                                           background: white; color: #31D7CA; cursor: pointer; font-size: 0.85rem; font-weight: 600;">
                                üîÑ Regenerate
                            </button>
                        </div>
                    `;

                    imagesGrid.appendChild(card);
                });
            });
        }

        async function regenerateSingleImage(index) {
            const img = generatedImages[index];
            const prompt = document.getElementById('promptText').value;
            const btn = document.getElementById(`regen-btn-${index}`);
            const imgEl = document.getElementById(`image-preview-${index}`);

            // Update button to show loading
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Generating...';
            btn.style.opacity = '0.7';
            imgEl.style.opacity = '0.5';

            try {
                const response = await fetch('/api/generate-single-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        platform: img.platform,
                        width: img.width,
                        height: img.height,
                        sizeName: img.size
                    })
                });

                const result = await response.json();

                if (result.success && result.image) {
                    // Update the image in our array
                    generatedImages[index].url = result.image.url;
                    // Update the displayed image
                    imgEl.src = result.image.url;
                    console.log(`[DEBUG] Regenerated image ${index} successfully`);
                } else {
                    alert('Failed to regenerate image: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error regenerating image:', error);
                alert('Error regenerating image: ' + error.message);
            } finally {
                // Restore button
                btn.disabled = false;
                btn.innerHTML = 'üîÑ Regenerate';
                btn.style.opacity = '1';
                imgEl.style.opacity = '1';
            }
        }

        function backToPromptEdit() {
            document.getElementById('step4').classList.add('hidden');
            document.getElementById('step3').classList.remove('hidden');
            currentStep = 3;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function regenerateImagesFromStep4() {
            document.getElementById('step4').classList.add('hidden');
            document.getElementById('step3').classList.remove('hidden');
            currentStep = 3;
            window.scrollTo({ top: 0, behavior: 'smooth' });
            // User can then click "Generate Images" again
        }

        function goToTextOverlay() {
            renderTextOverlayPage();
            document.getElementById('step4').classList.add('hidden');
            document.getElementById('step5').classList.remove('hidden');
            currentStep = 5;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function backToImagePreview() {
            document.getElementById('step5').classList.add('hidden');
            document.getElementById('step4').classList.remove('hidden');
            currentStep = 4;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function goToLogoPlacement() {
            renderLogoPlacementPage();
            document.getElementById('step5').classList.add('hidden');
            document.getElementById('step6').classList.remove('hidden');
            currentStep = 6;
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // Update buttons based on platform type
            const afterLogoBtn = document.getElementById('afterLogoBtn');
            const skipCopyBtn = document.getElementById('skipCopyBtn');

            if (shouldSkipCopyGeneration()) {
                // General Image or Google Ads: only show Preview & Download as primary
                if (afterLogoBtn) afterLogoBtn.textContent = 'Preview & Download ‚Üí';
                if (skipCopyBtn) skipCopyBtn.style.display = 'none';
            } else {
                // Other platforms: show both options
                if (afterLogoBtn) afterLogoBtn.textContent = 'Generate Ad Copy ‚Üí';
                if (skipCopyBtn) skipCopyBtn.style.display = 'inline-block';
            }
        }

        function backToTextOverlay() {
            document.getElementById('step6').classList.add('hidden');
            document.getElementById('step5').classList.remove('hidden');
            currentStep = 5;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Track which text box is currently selected for editing
        let selectedTextBox = {};

        function renderTextOverlayPage() {
            const textOverlayGrid = document.getElementById('textOverlayGrid');
            textOverlayGrid.innerHTML = '';

            generatedImages.forEach((img, index) => {
                // Initialize text overlays array if not exists (support multiple text boxes)
                if (!textOverlays[index] || !Array.isArray(textOverlays[index])) {
                    // Convert old single object format to array format
                    const oldData = textOverlays[index];
                    textOverlays[index] = oldData && oldData.text ? [oldData] : [];
                }

                // Set default selected text box
                if (selectedTextBox[index] === undefined) {
                    selectedTextBox[index] = textOverlays[index].length > 0 ? 0 : -1;
                }

                const card = document.createElement('div');
                card.style.cssText = 'border: 2px solid #E1E7EF; border-radius: 12px; padding: 2rem; background: white;';

                card.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <!-- Image Preview -->
                        <div>
                            <div id="preview-container-${index}" style="position: relative; border: 2px solid #E1E7EF; border-radius: 8px; overflow: hidden;">
                                <img id="preview-img-${index}" src="${img.url}" alt="${capitalizePlatform(img.platform)} ${img.size}"
                                     style="width: 100%; display: block;">
                                <div id="text-boxes-container-${index}" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none;">
                                    <!-- Text boxes will be rendered here -->
                                </div>
                            </div>
                            <p style="background: #F4F7FC; padding: 0.75rem; border-radius: 8px; margin-top: 0.75rem; color: #7DA3AF; font-size: 0.9rem; text-align: center;">
                                üí° <strong>Drag to move</strong> ‚Ä¢ <strong>Drag corners to resize</strong> ‚Ä¢ <strong>Click to select</strong>
                            </p>
                            <h4 style="margin-top: 1rem; color: #272D3F;">${capitalizePlatform(img.platform)} - ${img.size}</h4>
                            <p style="color: #7DA3AF; font-size: 0.9rem;">${img.width}x${img.height}</p>
                        </div>

                        <!-- Controls -->
                        <div>
                            <h3 style="margin-bottom: 1rem; color: #272D3F;">Text Overlay Settings</h3>

                            <div id="text-box-controls-${index}">
                                <!-- Controls will be rendered here based on selected text box -->
                            </div>

                            <button onclick="addNewTextBox(${index})" class="btn-secondary" style="width: 100%; margin-top: 1rem; padding: 0.75rem; background: #31D7CA; color: white; border: none;">
                                + New Text Box
                            </button>
                        </div>
                    </div>
                `;

                textOverlayGrid.appendChild(card);

                // Render text boxes and controls
                setTimeout(() => {
                    renderAllTextBoxes(index);
                    renderTextBoxControls(index);
                }, 100);
            });
        }

        function addNewTextBox(imageIndex) {
            const newTextBox = {
                text: 'New text',
                x: 50,
                y: 30 + (textOverlays[imageIndex].length * 20) % 60, // Stagger vertically
                fontSize: 28,
                textColor: '#FFFFFF',
                bgColor: 'rgba(0, 0, 0, 0.7)',
                fontFamily: 'Gilroy'
            };

            textOverlays[imageIndex].push(newTextBox);
            selectedTextBox[imageIndex] = textOverlays[imageIndex].length - 1;

            renderAllTextBoxes(imageIndex);
            renderTextBoxControls(imageIndex);
        }

        function deleteTextBox(imageIndex, boxIndex) {
            if (textOverlays[imageIndex].length <= 1) {
                // Don't delete the last text box, just clear it
                textOverlays[imageIndex][0].text = '';
                selectedTextBox[imageIndex] = 0;
            } else {
                textOverlays[imageIndex].splice(boxIndex, 1);
                if (selectedTextBox[imageIndex] >= textOverlays[imageIndex].length) {
                    selectedTextBox[imageIndex] = textOverlays[imageIndex].length - 1;
                }
            }

            renderAllTextBoxes(imageIndex);
            renderTextBoxControls(imageIndex);
        }

        function selectTextBox(imageIndex, boxIndex) {
            selectedTextBox[imageIndex] = boxIndex;
            renderAllTextBoxes(imageIndex);
            renderTextBoxControls(imageIndex);
        }

        function renderTextBoxControls(imageIndex) {
            const controlsContainer = document.getElementById(`text-box-controls-${imageIndex}`);
            const boxes = textOverlays[imageIndex];
            const selectedIdx = selectedTextBox[imageIndex];

            if (boxes.length === 0 || selectedIdx < 0 || selectedIdx >= boxes.length) {
                controlsContainer.innerHTML = `
                    <p style="color: #7DA3AF; text-align: center; padding: 2rem;">
                        Click "New Text Box" to add text to your image
                    </p>
                `;
                return;
            }

            const box = boxes[selectedIdx];

            controlsContainer.innerHTML = `
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                    ${boxes.map((b, i) => `
                        <button onclick="selectTextBox(${imageIndex}, ${i})"
                                style="padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.85rem; cursor: pointer;
                                       background: ${i === selectedIdx ? '#31D7CA' : '#F4F7FC'};
                                       color: ${i === selectedIdx ? 'white' : '#272D3F'};
                                       border: 2px solid ${i === selectedIdx ? '#31D7CA' : '#E1E7EF'};">
                            Text ${i + 1}
                        </button>
                    `).join('')}
                </div>

                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #272D3F;">Text Content</label>
                <textarea id="overlay-text-${imageIndex}"
                       placeholder="Enter your text... (Press Enter for new line)"
                       rows="3"
                       style="width: 100%; padding: 0.75rem; border: 2px solid #E1E7EF; border-radius: 8px; margin-bottom: 1rem; font-size: 1rem; font-family: inherit; resize: vertical;"
                       oninput="updateSelectedTextBox(${imageIndex})">${box.text}</textarea>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #272D3F; font-size: 0.9rem;">Font</label>
                        <select id="overlay-font-${imageIndex}" onchange="updateSelectedTextBox(${imageIndex})"
                                style="width: 100%; padding: 0.5rem; border: 2px solid #E1E7EF; border-radius: 8px; font-size: 0.9rem;">
                            <option value="Gilroy" ${box.fontFamily === 'Gilroy' ? 'selected' : ''}>Gilroy</option>
                            <option value="Arial" ${box.fontFamily === 'Arial' ? 'selected' : ''}>Arial</option>
                            <option value="Helvetica" ${box.fontFamily === 'Helvetica' ? 'selected' : ''}>Helvetica</option>
                            <option value="Georgia" ${box.fontFamily === 'Georgia' ? 'selected' : ''}>Georgia</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #272D3F; font-size: 0.9rem;">Text Color</label>
                        <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                            <div style="display: flex; gap: 0.25rem;">
                                <button type="button" onclick="setTextColor(${imageIndex}, '#FFFFFF')" title="White #FFFFFF"
                                        style="width: 28px; height: 28px; border-radius: 4px; border: 2px solid ${box.textColor === '#FFFFFF' ? '#31D7CA' : '#E1E7EF'}; background: #FFFFFF; cursor: pointer;"></button>
                                <button type="button" onclick="setTextColor(${imageIndex}, '#31D7CA')" title="Turquoise #31D7CA"
                                        style="width: 28px; height: 28px; border-radius: 4px; border: 2px solid ${box.textColor === '#31D7CA' ? '#272D3F' : '#E1E7EF'}; background: #31D7CA; cursor: pointer;"></button>
                                <button type="button" onclick="setTextColor(${imageIndex}, '#272D3F')" title="Navy #272D3F"
                                        style="width: 28px; height: 28px; border-radius: 4px; border: 2px solid ${box.textColor === '#272D3F' ? '#31D7CA' : '#E1E7EF'}; background: #272D3F; cursor: pointer;"></button>
                                <button type="button" onclick="setTextColor(${imageIndex}, '#FC883A')" title="Orange #FC883A"
                                        style="width: 28px; height: 28px; border-radius: 4px; border: 2px solid ${box.textColor === '#FC883A' ? '#272D3F' : '#E1E7EF'}; background: #FC883A; cursor: pointer;"></button>
                                <button type="button" onclick="setTextColor(${imageIndex}, '#000000')" title="Black #000000"
                                        style="width: 28px; height: 28px; border-radius: 4px; border: 2px solid ${box.textColor === '#000000' ? '#31D7CA' : '#E1E7EF'}; background: #000000; cursor: pointer;"></button>
                            </div>
                            <input type="color" id="overlay-textcolor-${imageIndex}" value="${box.textColor}"
                                   onchange="updateSelectedTextBox(${imageIndex})"
                                   style="width: 38px; height: 28px; padding: 0; border: 2px solid #E1E7EF; border-radius: 4px; cursor: pointer;"
                                   title="Custom color">
                        </div>
                    </div>
                </div>

                <label style="display: block; font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem; color: #272D3F; font-size: 0.9rem;">Background</label>
                <select id="overlay-bg-${imageIndex}" onchange="updateSelectedTextBox(${imageIndex})"
                        style="width: 100%; padding: 0.5rem; border: 2px solid #E1E7EF; border-radius: 8px; font-size: 0.9rem;">
                    <option value="rgba(0, 0, 0, 0.7)" ${box.bgColor === 'rgba(0, 0, 0, 0.7)' ? 'selected' : ''}>Dark (70%)</option>
                    <option value="rgba(0, 0, 0, 0.5)" ${box.bgColor === 'rgba(0, 0, 0, 0.5)' ? 'selected' : ''}>Dark (50%)</option>
                    <option value="rgba(49, 215, 202, 0.9)" ${box.bgColor === 'rgba(49, 215, 202, 0.9)' ? 'selected' : ''}>Turquoise</option>
                    <option value="rgba(39, 45, 63, 0.9)" ${box.bgColor === 'rgba(39, 45, 63, 0.9)' ? 'selected' : ''}>Navy</option>
                    <option value="none" ${box.bgColor === 'none' ? 'selected' : ''}>None</option>
                </select>

                <button onclick="deleteTextBox(${imageIndex}, ${selectedIdx})" class="btn-secondary"
                        style="width: 100%; margin-top: 1rem; padding: 0.5rem; color: #FF6B6B; border-color: #FF6B6B; font-size: 0.9rem;">
                    Delete This Text Box
                </button>
            `;
        }

        function setTextColor(imageIndex, color) {
            const selectedIdx = selectedTextBox[imageIndex];
            if (selectedIdx < 0 || selectedIdx >= textOverlays[imageIndex].length) return;

            // Update the color picker input
            document.getElementById(`overlay-textcolor-${imageIndex}`).value = color;

            // Update the text box
            textOverlays[imageIndex][selectedIdx].textColor = color;

            // Re-render
            renderAllTextBoxes(imageIndex);
            renderTextBoxControls(imageIndex);
        }

        function updateSelectedTextBox(imageIndex) {
            const selectedIdx = selectedTextBox[imageIndex];
            if (selectedIdx < 0 || selectedIdx >= textOverlays[imageIndex].length) return;

            const box = textOverlays[imageIndex][selectedIdx];
            box.text = document.getElementById(`overlay-text-${imageIndex}`).value;
            box.fontFamily = document.getElementById(`overlay-font-${imageIndex}`).value;
            box.textColor = document.getElementById(`overlay-textcolor-${imageIndex}`).value;
            box.bgColor = document.getElementById(`overlay-bg-${imageIndex}`).value;

            renderAllTextBoxes(imageIndex);
        }

        function renderAllTextBoxes(imageIndex) {
            const container = document.getElementById(`text-boxes-container-${imageIndex}`);
            const boxes = textOverlays[imageIndex];
            const selectedIdx = selectedTextBox[imageIndex];

            container.innerHTML = '';

            boxes.forEach((box, boxIdx) => {
                if (!box.text) return;

                const isSelected = boxIdx === selectedIdx;
                const bgStyle = box.bgColor === 'none' ? 'background: transparent;' : `background: ${box.bgColor};`;

                const textBoxEl = document.createElement('div');
                textBoxEl.className = 'resizable-text-box';
                textBoxEl.dataset.imageIndex = imageIndex;
                textBoxEl.dataset.boxIndex = boxIdx;
                textBoxEl.style.cssText = `
                    position: absolute;
                    top: ${box.y}%;
                    left: ${box.x}%;
                    transform: translate(-50%, -50%);
                    cursor: move;
                    pointer-events: auto;
                    ${isSelected ? 'outline: 2px dashed #31D7CA; outline-offset: 4px;' : ''}
                `;

                textBoxEl.innerHTML = `
                    <div style="display: inline-block; ${bgStyle} padding: 10px 20px; border-radius: 8px; text-align: center; position: relative;">
                        <p style="color: ${box.textColor}; font-family: '${box.fontFamily}', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: ${box.fontSize}px; font-weight: 700; margin: 0; line-height: 1.3; white-space: pre-line;">${box.text}</p>
                        ${isSelected ? `
                            <div class="resize-handle resize-handle-br" style="position: absolute; bottom: -6px; right: -6px; width: 12px; height: 12px; background: #31D7CA; border-radius: 50%; cursor: se-resize;"></div>
                            <div class="resize-handle resize-handle-bl" style="position: absolute; bottom: -6px; left: -6px; width: 12px; height: 12px; background: #31D7CA; border-radius: 50%; cursor: sw-resize;"></div>
                            <div class="resize-handle resize-handle-tr" style="position: absolute; top: -6px; right: -6px; width: 12px; height: 12px; background: #31D7CA; border-radius: 50%; cursor: ne-resize;"></div>
                            <div class="resize-handle resize-handle-tl" style="position: absolute; top: -6px; left: -6px; width: 12px; height: 12px; background: #31D7CA; border-radius: 50%; cursor: nw-resize;"></div>
                        ` : ''}
                    </div>
                `;

                container.appendChild(textBoxEl);

                // Setup drag and resize handlers
                setupTextBoxHandlers(textBoxEl, imageIndex, boxIdx);
            });
        }

        function setupTextBoxHandlers(element, imageIndex, boxIndex) {
            const container = document.getElementById(`preview-container-${imageIndex}`);
            let isDragging = false;
            let isResizing = false;
            let resizeDirection = '';
            let startX, startY, startLeft, startTop, startFontSize;

            // Click to select
            element.addEventListener('click', (e) => {
                if (!isResizing) {
                    selectTextBox(imageIndex, boxIndex);
                }
            });

            // Drag to move
            element.addEventListener('mousedown', (e) => {
                if (e.target.classList.contains('resize-handle')) {
                    // Start resizing
                    isResizing = true;
                    resizeDirection = e.target.classList.contains('resize-handle-br') ? 'br' :
                                     e.target.classList.contains('resize-handle-bl') ? 'bl' :
                                     e.target.classList.contains('resize-handle-tr') ? 'tr' : 'tl';
                    startX = e.clientX;
                    startY = e.clientY;
                    startFontSize = textOverlays[imageIndex][boxIndex].fontSize;
                } else {
                    // Start dragging
                    isDragging = true;
                    const rect = container.getBoundingClientRect();
                    startX = e.clientX;
                    startY = e.clientY;
                    startLeft = textOverlays[imageIndex][boxIndex].x;
                    startTop = textOverlays[imageIndex][boxIndex].y;
                }
                e.preventDefault();
                e.stopPropagation();
            });

            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    const rect = container.getBoundingClientRect();
                    const deltaX = e.clientX - startX;
                    const deltaY = e.clientY - startY;

                    let newX = startLeft + (deltaX / rect.width) * 100;
                    let newY = startTop + (deltaY / rect.height) * 100;

                    newX = Math.max(10, Math.min(90, newX));
                    newY = Math.max(10, Math.min(90, newY));

                    textOverlays[imageIndex][boxIndex].x = newX;
                    textOverlays[imageIndex][boxIndex].y = newY;

                    element.style.left = newX + '%';
                    element.style.top = newY + '%';
                } else if (isResizing) {
                    const deltaY = e.clientY - startY;
                    const deltaX = e.clientX - startX;

                    // Calculate resize based on diagonal movement
                    let delta = 0;
                    if (resizeDirection === 'br') delta = (deltaX + deltaY) / 4;
                    else if (resizeDirection === 'bl') delta = (-deltaX + deltaY) / 4;
                    else if (resizeDirection === 'tr') delta = (deltaX - deltaY) / 4;
                    else delta = (-deltaX - deltaY) / 4;

                    const newFontSize = Math.max(12, Math.min(96, startFontSize + delta));
                    textOverlays[imageIndex][boxIndex].fontSize = Math.round(newFontSize);

                    renderAllTextBoxes(imageIndex);
                }
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
                isResizing = false;
            });
        }

        // Note: setupDragHandler and updateTextOverlayPreview have been replaced
        // by the new multiple text box system (renderAllTextBoxes, setupTextBoxHandlers, etc.)

        function renderLogoPlacementPage() {
            const logoGrid = document.getElementById('logoGrid');
            logoGrid.innerHTML = '';

            generatedImages.forEach((img, index) => {
                // Initialize logo settings if not exists
                if (!logoSettings[index]) {
                    logoSettings[index] = {
                        x: 50, // Percentage from left (center)
                        y: 50, // Percentage from top (center)
                        scale: 27, // Logo size percentage (27% of image width - middle of range)
                        enabled: false, // Default to disabled - user must opt-in
                        selectedLogoIndex: 0 // Default to first logo
                    };
                }

                const card = document.createElement('div');
                card.style.cssText = 'border: 2px solid #E1E7EF; border-radius: 12px; padding: 2rem; background: white;';

                card.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <!-- Image Preview with Text & Logo -->
                        <div>
                            <div id="logo-preview-container-${index}" style="position: relative; border: 2px solid #E1E7EF; border-radius: 8px; overflow: hidden; cursor: move;">
                                <img id="logo-preview-img-${index}" src="${img.url}" alt="${capitalizePlatform(img.platform)} ${img.size}" style="width: 100%; display: block;">
                                <div id="final-text-${index}" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none;"></div>
                                <div id="logo-draggable-${index}" class="draggable-logo" data-index="${index}"
                                     style="position: absolute; top: ${logoSettings[index].y}%; left: ${logoSettings[index].x}%; transform: translate(-50%, -50%); cursor: move; pointer-events: auto;">
                                </div>
                            </div>
                            <p style="background: #F4F7FC; padding: 0.75rem; border-radius: 8px; margin-top: 0.75rem; color: #7DA3AF; font-size: 0.9rem; text-align: center;">
                                üí° <strong>Drag the logo</strong> to position it anywhere on the image
                            </p>
                            <h4 style="margin-top: 1rem; color: #272D3F;">${capitalizePlatform(img.platform)} - ${img.size}</h4>
                            <p style="color: #7DA3AF; font-size: 0.9rem;">${img.width}x${img.height}</p>
                            <button onclick="downloadAdImage(${index})" class="btn-secondary" style="width: 100%; margin-top: 1rem;">
                                Download Ad
                            </button>
                        </div>

                        <!-- Logo Controls -->
                        <div>
                            <h3 style="margin-bottom: 1rem; color: #272D3F;">Logo Settings</h3>

                            <p style="color: #7DA3AF; font-size: 0.9rem; margin-bottom: 1rem;">Click a logo below to add it to your image. Click again to deselect.</p>

                            <!-- Hidden checkbox for backwards compatibility -->
                            <input type="checkbox" id="logo-enabled-${index}" ${logoSettings[index].enabled ? 'checked' : ''} style="display: none;">

                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #272D3F;">Select Logo/Emblem</label>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-bottom: 1.5rem;">
                                ${availableLogos.map((logo, logoIdx) => `
                                    <div onclick="selectLogo(${index}, ${logoIdx})"
                                         id="logo-option-${index}-${logoIdx}"
                                         style="border: 3px solid ${logoSettings[index].selectedLogoIndex === logoIdx ? '#31D7CA' : '#E1E7EF'};
                                                border-radius: 8px; padding: 0.5rem; cursor: pointer; background: white;
                                                transition: all 0.2s ease; height: 120px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                        <img src="${logo.url}" alt="${logo.name}"
                                             style="max-width: 100%; max-height: 100%; object-fit: contain; display: block;">
                                    </div>
                                `).join('')}
                            </div>

                            <label id="logo-scale-label-${index}" style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #272D3F;">Logo Size</label>
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
                                <span style="font-size: 0.85rem; color: #7DA3AF;">Smaller</span>
                                <input type="range" id="logo-scale-${index}" value="${logoSettings[index].scale}" min="5" max="50" step="1"
                                       oninput="updateLogoPreview(${index})"
                                       style="flex: 1;">
                                <span style="font-size: 0.85rem; color: #7DA3AF;">Larger</span>
                            </div>
                        </div>
                    </div>
                `;

                logoGrid.appendChild(card);

                // Render text overlay and logo, then setup drag handler
                setTimeout(() => {
                    updateLogoPreview(index);
                    setupLogoDragHandler(index);
                }, 100);
            });
        }

        function setupLogoDragHandler(index) {
            const logoElement = document.getElementById(`logo-draggable-${index}`);
            const container = document.getElementById(`logo-preview-container-${index}`);

            if (!logoElement || !container) return;

            let isDragging = false;
            let startX, startY, startLeft, startTop;

            logoElement.addEventListener('mousedown', function(e) {
                const selectedLogoIndex = logoSettings[index].selectedLogoIndex || 0;
                if (!logoSettings[index].enabled || !availableLogos[selectedLogoIndex]) return;

                isDragging = true;
                const rect = container.getBoundingClientRect();
                const logoRect = logoElement.getBoundingClientRect();

                startX = e.clientX;
                startY = e.clientY;
                startLeft = ((logoRect.left + logoRect.width / 2 - rect.left) / rect.width) * 100;
                startTop = ((logoRect.top + logoRect.height / 2 - rect.top) / rect.height) * 100;

                e.preventDefault();
            });

            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;

                const rect = container.getBoundingClientRect();
                const deltaX = e.clientX - startX;
                const deltaY = e.clientY - startY;

                let newX = startLeft + (deltaX / rect.width) * 100;
                let newY = startTop + (deltaY / rect.height) * 100;

                // Constrain to image bounds
                newX = Math.max(5, Math.min(95, newX));
                newY = Math.max(5, Math.min(95, newY));

                logoSettings[index].x = newX;
                logoSettings[index].y = newY;

                logoElement.style.left = newX + '%';
                logoElement.style.top = newY + '%';

                e.preventDefault();
            });

            document.addEventListener('mouseup', function() {
                isDragging = false;
            });
        }

        function selectLogo(index, logoIdx) {
            const checkbox = document.getElementById(`logo-enabled-${index}`);
            const currentlySelected = logoSettings[index].selectedLogoIndex;
            const isCurrentlyEnabled = logoSettings[index].enabled;

            // Toggle behavior: if clicking the same logo that's already enabled, disable it
            if (currentlySelected === logoIdx && isCurrentlyEnabled) {
                // Deselect - remove logo
                logoSettings[index].enabled = false;
                checkbox.checked = false;

                // Remove highlight from all logos
                availableLogos.forEach((_, i) => {
                    const optionElement = document.getElementById(`logo-option-${index}-${i}`);
                    if (optionElement) {
                        optionElement.style.border = '3px solid #E1E7EF';
                    }
                });
            } else {
                // Select this logo and enable it
                logoSettings[index].selectedLogoIndex = logoIdx;
                logoSettings[index].enabled = true;
                checkbox.checked = true;

                // Update borders for all logo options
                availableLogos.forEach((_, i) => {
                    const optionElement = document.getElementById(`logo-option-${index}-${i}`);
                    if (optionElement) {
                        optionElement.style.border = i === logoIdx ? '3px solid #31D7CA' : '3px solid #E1E7EF';
                    }
                });
            }

            updateLogoPreview(index);
        }

        function updateLogoPreview(index) {
            const img = generatedImages[index];
            const overlays = textOverlays[index]; // Now an array
            const logoEnabled = document.getElementById(`logo-enabled-${index}`).checked;
            const logoScale = document.getElementById(`logo-scale-${index}`).value;
            const selectedLogoIndex = logoSettings[index].selectedLogoIndex || 0;

            // Store settings
            logoSettings[index].enabled = logoEnabled;
            logoSettings[index].scale = parseFloat(logoScale);
            logoSettings[index].selectedLogoIndex = selectedLogoIndex;

            // Render all text overlays
            const textPreview = document.getElementById(`final-text-${index}`);
            textPreview.innerHTML = '';

            if (Array.isArray(overlays)) {
                overlays.forEach(overlay => {
                    if (overlay && overlay.text) {
                        const positionStyles = `top: ${overlay.y || 85}%; left: ${overlay.x || 50}%; transform: translate(-50%, -50%);`;
                        const bgStyle = overlay.bgColor === 'none' ? 'background: transparent;' : `background: ${overlay.bgColor};`;

                        textPreview.innerHTML += `
                            <div style="position: absolute; ${positionStyles}">
                                <div style="display: inline-block; ${bgStyle} padding: 10px 20px; border-radius: 8px; text-align: center;">
                                    <p style="color: ${overlay.textColor}; font-family: '${overlay.fontFamily}', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: ${overlay.fontSize}px; font-weight: 700; margin: 0; line-height: 1.3; white-space: pre-line;">${overlay.text}</p>
                                </div>
                            </div>
                        `;
                    }
                });
            } else if (overlays && overlays.text) {
                // Backwards compatibility for old single-object format
                const overlay = overlays;
                const positionStyles = `top: ${overlay.y || 85}%; left: ${overlay.x || 50}%; transform: translate(-50%, -50%);`;
                const bgStyle = overlay.bgColor === 'none' ? 'background: transparent;' : `background: ${overlay.bgColor};`;

                textPreview.innerHTML = `
                    <div style="position: absolute; ${positionStyles}">
                        <div style="display: inline-block; ${bgStyle} padding: 10px 20px; border-radius: 8px; text-align: center;">
                            <p style="color: ${overlay.textColor}; font-family: '${overlay.fontFamily}', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: ${overlay.fontSize}px; font-weight: 700; margin: 0; line-height: 1.3; white-space: pre-line;">${overlay.text}</p>
                        </div>
                    </div>
                `;
            }

            // Render logo
            const logoPreview = document.getElementById(`logo-draggable-${index}`);
            const selectedLogo = availableLogos[selectedLogoIndex];

            if (logoEnabled && selectedLogo) {
                // Calculate logo width based on actual image width (not preview container)
                // Preview image is displayed with "width: 100%" of container
                // We need the logo to appear proportional to the actual final image
                const previewImg = document.getElementById(`logo-preview-img-${index}`);
                const previewWidth = previewImg ? previewImg.clientWidth : 500;

                // Scale logo based on actual image dimensions
                // logoScale is percentage of image width we want the logo to be
                const logoWidthPx = (logoScale / 100) * previewWidth;

                logoPreview.style.pointerEvents = 'auto';
                logoPreview.innerHTML = `
                    <img src="${selectedLogo.url}" alt="${selectedLogo.name}"
                         style="width: ${logoWidthPx}px; height: auto; display: block; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); pointer-events: none;">
                `;
            } else {
                logoPreview.innerHTML = '';
                logoPreview.style.pointerEvents = 'none';
            }
        }

        function goToNextAfterLogo() {
            // For General Image or Google Ads (Demand Gen, PMax), skip ad copy and go directly to preview
            if (shouldSkipCopyGeneration()) {
                if (isGeneralImageOnly()) {
                    goToGeneralImagePreview();
                } else {
                    // Google Ads platforms - skip copy, go to preview
                    goToPreviewSkipCopy();
                }
            } else {
                goToAdCopy();
            }
        }

        // Skip copy and go directly to preview (for Meta, Reddit, Pinterest)
        function goToPreviewSkipCopy() {
            skippedCopyFlow = true; // Track that user skipped copy
            renderPreviewPage();
            document.getElementById('step6').classList.add('hidden');
            document.getElementById('stepPreview').classList.remove('hidden');
            currentStep = 'preview';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function renderPreviewPage() {
            const previewGrid = document.getElementById('previewGrid');
            previewGrid.innerHTML = '';

            generatedImages.forEach((img, index) => {
                const overlay = textOverlays[index] || {};
                const logo = logoSettings[index] || {};

                const card = document.createElement('div');
                card.style.cssText = 'border: 2px solid #E1E7EF; border-radius: 12px; padding: 1.5rem; background: white;';

                card.innerHTML = `
                    <h3 style="color: #272D3F; margin-bottom: 1rem;">${capitalizePlatform(img.platform)} - ${img.size}</h3>
                    <div style="position: relative; background: #F4F7FC; border-radius: 12px; padding: 1rem; margin-bottom: 1rem;">
                        <canvas id="preview-canvas-${index}" style="width: 100%; border-radius: 8px; display: block;"></canvas>
                    </div>
                    <p style="color: #7DA3AF; font-size: 0.9rem; margin-bottom: 1rem;">${img.width}x${img.height}</p>
                    <button onclick="downloadPreviewImage(${index})" class="btn-primary" style="width: 100%;">
                        Download Image
                    </button>
                `;

                previewGrid.appendChild(card);

                // Render canvas after adding to DOM
                setTimeout(() => renderPreviewCanvas(index), 50);
            });
        }

        function renderPreviewCanvas(index) {
            const canvas = document.getElementById(`preview-canvas-${index}`);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const img = generatedImages[index];
            const overlays = textOverlays[index];
            const logo = logoSettings[index] || {};

            const image = new Image();
            image.crossOrigin = 'anonymous';
            image.onload = function() {
                canvas.width = image.width;
                canvas.height = image.height;
                ctx.drawImage(image, 0, 0);

                // Draw text overlays - handle both array and single object format
                const overlayList = Array.isArray(overlays) ? overlays : (overlays && overlays.text ? [overlays] : []);

                overlayList.forEach(overlay => {
                    if (!overlay || !overlay.text) return;

                    const fontSize = Math.round((overlay.fontSize || 28) * (image.width / 400));
                    ctx.font = `bold ${fontSize}px ${overlay.fontFamily || 'Gilroy'}, Arial, sans-serif`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';

                    const x = (overlay.x / 100) * canvas.width;
                    const y = (overlay.y / 100) * canvas.height;

                    // Handle multi-line text
                    const lines = overlay.text.split('\n');
                    const lineHeight = fontSize * 1.3;

                    // Background
                    if (overlay.bgColor && overlay.bgColor !== 'none') {
                        let maxWidth = 0;
                        lines.forEach(line => {
                            const metrics = ctx.measureText(line);
                            if (metrics.width > maxWidth) maxWidth = metrics.width;
                        });
                        const padding = 30;
                        const bgHeight = lineHeight * lines.length + padding;

                        ctx.fillStyle = overlay.bgColor;
                        ctx.fillRect(x - maxWidth / 2 - padding, y - bgHeight / 2, maxWidth + padding * 2, bgHeight);
                    }

                    // Text - draw each line
                    ctx.fillStyle = overlay.textColor || '#FFFFFF';
                    const totalHeight = lineHeight * (lines.length - 1);
                    lines.forEach((line, lineIdx) => {
                        const lineY = y - totalHeight / 2 + lineIdx * lineHeight;
                        ctx.fillText(line, x, lineY);
                    });
                });

                // Draw logo if enabled
                const selectedLogoIndex = logo.selectedLogoIndex || 0;
                if (logo.enabled && availableLogos[selectedLogoIndex]) {
                    const logoImg = new Image();
                    logoImg.crossOrigin = 'anonymous';
                    logoImg.onload = function() {
                        const logoScale = (logo.scale || 15) / 100;
                        const logoWidth = canvas.width * logoScale;
                        const logoHeight = (logoImg.height / logoImg.width) * logoWidth;

                        let logoX, logoY;
                        if (logo.x !== undefined && logo.y !== undefined) {
                            logoX = (logo.x / 100) * canvas.width - logoWidth / 2;
                            logoY = (logo.y / 100) * canvas.height - logoHeight / 2;
                        } else {
                            logoX = canvas.width - logoWidth - 20;
                            logoY = canvas.height - logoHeight - 20;
                        }

                        ctx.drawImage(logoImg, logoX, logoY, logoWidth, logoHeight);
                    };
                    logoImg.src = availableLogos[selectedLogoIndex].url;
                }
            };
            image.src = img.url;
        }

        async function downloadPreviewImage(index) {
            const canvas = document.getElementById(`preview-canvas-${index}`);
            if (!canvas) return;

            const img = generatedImages[index];
            const link = document.createElement('a');
            link.download = `${capitalizePlatform(img.platform)}_${img.size.replace(/\s+/g, '_')}_${img.width}x${img.height}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        function backToLogoFromPreview() {
            document.getElementById('stepPreview').classList.add('hidden');
            document.getElementById('step6').classList.remove('hidden');
            currentStep = 6;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function downloadAllPreviewImages() {
            for (let i = 0; i < generatedImages.length; i++) {
                await downloadPreviewImage(i);
                await new Promise(resolve => setTimeout(resolve, 300));
            }
        }

        function goToGifFromPreview() {
            renderGifSelection();
            document.getElementById('stepPreview').classList.add('hidden');
            document.getElementById('step9').classList.remove('hidden');
            currentStep = 10;
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // Update back button text
            const backBtn = document.getElementById('backFromGifBtn');
            if (backBtn) {
                backBtn.textContent = '‚Üê Back to Preview';
            }
        }

        function goToAdCopyFromPreview() {
            renderAdCopyPage();
            document.getElementById('stepPreview').classList.add('hidden');
            document.getElementById('step7').classList.remove('hidden');
            currentStep = 7;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function goToAdCopy() {
            renderAdCopyPage();
            document.getElementById('step6').classList.add('hidden');
            document.getElementById('step7').classList.remove('hidden');
            currentStep = 7;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function goToGeneralImagePreview() {
            renderGeneralImagePreview();
            document.getElementById('step6').classList.add('hidden');
            document.getElementById('stepGeneralPreview').classList.remove('hidden');
            currentStep = 9;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function renderGeneralImagePreview() {
            const previewGrid = document.getElementById('generalPreviewGrid');
            previewGrid.innerHTML = '';

            generatedImages.forEach((img, index) => {
                const overlay = textOverlays[index] || {};
                const logo = logoSettings[index] || {};
                const selectedLogoIndex = logo.selectedLogoIndex || 0;

                const card = document.createElement('div');
                card.style.cssText = 'border: 2px solid #E1E7EF; border-radius: 12px; padding: 1.5rem; background: white;';

                card.innerHTML = `
                    <h3 style="color: #272D3F; margin-bottom: 1rem;">${capitalizePlatform(img.platform)} - ${img.size}</h3>
                    <div style="position: relative; background: #F4F7FC; border-radius: 12px; padding: 1rem; margin-bottom: 1rem;">
                        <canvas id="general-preview-canvas-${index}" style="width: 100%; border-radius: 8px; display: block;"></canvas>
                    </div>
                    <p style="color: #7DA3AF; font-size: 0.9rem; margin-bottom: 1rem;">${img.width}x${img.height}</p>
                    <button onclick="downloadGeneralImage(${index})" class="btn-primary" style="width: 100%;">
                        Download Image
                    </button>
                `;

                previewGrid.appendChild(card);

                // Render canvas after adding to DOM
                setTimeout(() => renderGeneralPreviewCanvas(index), 50);
            });
        }

        function renderGeneralPreviewCanvas(index) {
            const canvas = document.getElementById(`general-preview-canvas-${index}`);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const img = generatedImages[index];
            const overlays = textOverlays[index];
            const logo = logoSettings[index] || {};

            const image = new Image();
            image.crossOrigin = 'anonymous';
            image.onload = function() {
                canvas.width = image.width;
                canvas.height = image.height;
                ctx.drawImage(image, 0, 0);

                // Draw text overlays - handle both array and single object format
                const overlayList = Array.isArray(overlays) ? overlays : (overlays && overlays.text ? [overlays] : []);

                overlayList.forEach(overlay => {
                    if (!overlay || !overlay.text) return;

                    const fontSize = Math.round((overlay.fontSize || overlay.size || 28) * (image.width / 400));
                    ctx.font = `bold ${fontSize}px ${overlay.fontFamily || overlay.font || 'Gilroy'}, Arial, sans-serif`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';

                    const x = (overlay.x / 100) * canvas.width;
                    const y = (overlay.y / 100) * canvas.height;

                    // Handle multi-line text
                    const lines = overlay.text.split('\n');
                    const lineHeight = fontSize * 1.3;

                    // Background
                    if (overlay.bgColor && overlay.bgColor !== 'none') {
                        let maxWidth = 0;
                        lines.forEach(line => {
                            const metrics = ctx.measureText(line);
                            if (metrics.width > maxWidth) maxWidth = metrics.width;
                        });
                        const padding = 30;
                        const bgHeight = lineHeight * lines.length + padding;

                        ctx.fillStyle = overlay.bgColor;
                        ctx.fillRect(x - maxWidth / 2 - padding, y - bgHeight / 2, maxWidth + padding * 2, bgHeight);
                    }

                    // Text - draw each line
                    ctx.fillStyle = overlay.textColor || overlay.color || '#FFFFFF';
                    const totalHeight = lineHeight * (lines.length - 1);
                    lines.forEach((line, lineIdx) => {
                        const lineY = y - totalHeight / 2 + lineIdx * lineHeight;
                        ctx.fillText(line, x, lineY);
                    });
                });

                // Draw logo if enabled
                const selectedLogoIndex = logo.selectedLogoIndex || 0;
                if (logo.enabled && availableLogos[selectedLogoIndex]) {
                    const logoImg = new Image();
                    logoImg.crossOrigin = 'anonymous';
                    logoImg.onload = function() {
                        const logoScale = logo.scale || 0.15;
                        const logoWidth = canvas.width * logoScale;
                        const logoHeight = (logoImg.height / logoImg.width) * logoWidth;

                        let logoX, logoY;
                        if (logo.x !== undefined && logo.y !== undefined) {
                            logoX = (logo.x / 100) * canvas.width - logoWidth / 2;
                            logoY = (logo.y / 100) * canvas.height - logoHeight / 2;
                        } else {
                            logoX = canvas.width - logoWidth - 20;
                            logoY = canvas.height - logoHeight - 20;
                        }

                        ctx.drawImage(logoImg, logoX, logoY, logoWidth, logoHeight);
                    };
                    logoImg.src = availableLogos[selectedLogoIndex].url;
                }
            };
            image.src = img.url;
        }

        async function downloadGeneralImage(index) {
            const canvas = document.getElementById(`general-preview-canvas-${index}`);
            if (!canvas) return;

            const img = generatedImages[index];
            const link = document.createElement('a');
            link.download = `${capitalizePlatform(img.platform)}_${img.size.replace(/\s+/g, '_')}_${img.width}x${img.height}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        function backToLogoFromGeneral() {
            document.getElementById('stepGeneralPreview').classList.add('hidden');
            document.getElementById('step6').classList.remove('hidden');
            currentStep = 6;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function downloadAllGeneralImages() {
            for (let i = 0; i < generatedImages.length; i++) {
                await downloadGeneralImage(i);
                // Small delay between downloads
                await new Promise(resolve => setTimeout(resolve, 300));
            }
        }

        function goToGifFromGeneral() {
            renderGifSelection();
            document.getElementById('stepGeneralPreview').classList.add('hidden');
            document.getElementById('step9').classList.remove('hidden');
            currentStep = 10;
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // Update back button text
            const backBtn = document.getElementById('backFromGifBtn');
            if (backBtn) {
                backBtn.textContent = '‚Üê Back to Preview';
            }
        }

        function backToLogoPlacement() {
            document.getElementById('step7').classList.add('hidden');
            document.getElementById('step6').classList.remove('hidden');
            currentStep = 6;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function goToFinalReview() {
            renderFinalReviewPage();
            document.getElementById('step7').classList.add('hidden');
            document.getElementById('step8').classList.remove('hidden');
            currentStep = 8;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function backToAdCopy() {
            document.getElementById('step8').classList.add('hidden');
            document.getElementById('step7').classList.remove('hidden');
            currentStep = 7;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }


        let adCopyVariations = {}; // Store ad copy variations for each image
        let selectedAdCopy = {}; // Store selected ad copy for each image

        function renderAdCopyPage() {
            const adCopyGrid = document.getElementById('adCopyGrid');
            adCopyGrid.innerHTML = '';

            // Group images by base size to show ONE card per base size
            const sizeGroups = {};
            generatedImages.forEach((img, index) => {
                const baseSizeName = img.size.replace(/\s*-\s*Variation\s+\d+/, '');
                const groupKey = `${capitalizePlatform(img.platform)}|||${baseSizeName}`; // Use ||| as separator
                if (!sizeGroups[groupKey]) {
                    sizeGroups[groupKey] = {
                        platform: img.platform,
                        baseSizeName: baseSizeName,
                        width: img.width,
                        height: img.height,
                        indices: []
                    };
                }
                sizeGroups[groupKey].indices.push(index);
            });

            // Create ONE card per base size
            Object.values(sizeGroups).forEach(group => {
                const firstIndex = group.indices[0]; // Use first index as reference
                const card = document.createElement('div');
                card.style.cssText = 'border: 2px solid #E1E7EF; border-radius: 12px; padding: 2rem; background: white;';

                const variationCount = group.indices.length;

                card.innerHTML = `
                    <h3 style="margin-bottom: 0.5rem; color: #272D3F;">${capitalizePlatform(group.platform)} - ${group.baseSizeName}</h3>
                    <p style="color: #7DA3AF; font-size: 0.9rem; margin-bottom: 2rem;">${group.width}x${group.height}</p>

                    <div id="ad-copy-container-${firstIndex}" style="min-height: 400px;">
                        <div style="text-align: center; padding: 3rem;">
                            <div style="width: 40px; height: 40px; border: 4px solid #E1E7EF; border-top-color: #31D7CA; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
                            <p style="color: #7DA3AF; font-size: 1rem;">Generating ad copy variations...</p>
                        </div>
                    </div>
                `;

                adCopyGrid.appendChild(card);
            });

            // Generate ad copy with 3 variations for all images
            generateAdCopyWithVariations();
        }

        async function generateAdCopyWithVariations() {
            const campaignText = document.getElementById('campaignText').value;
            const provider = document.getElementById('aiProvider').value;

            // Group images by base size (without "- Variation X")
            const sizeGroups = {};
            generatedImages.forEach((img, index) => {
                // Extract base size name (e.g., "Square Feed" from "Square Feed - Variation 1")
                const baseSizeName = img.size.replace(/\s*-\s*Variation\s+\d+/, '');
                console.log(`[DEBUG] Image ${index}: Original="${img.size}", Platform="${capitalizePlatform(img.platform)}", Base="${baseSizeName}"`);
                if (!sizeGroups[baseSizeName]) {
                    sizeGroups[baseSizeName] = [];
                }
                sizeGroups[baseSizeName].push(index);
            });

            console.log('[DEBUG] Size groups:', sizeGroups);

            // Generate ad copy once per size group
            for (const [baseSizeName, indices] of Object.entries(sizeGroups)) {
                console.log(`[DEBUG] Generating ad copy for base size "${baseSizeName}" (applies to ${indices.length} variations: indices ${indices.join(', ')})`);

                const firstIndex = indices[0];
                const img = generatedImages[firstIndex];
                const overlays = textOverlays[firstIndex];
                const overlayList = Array.isArray(overlays) ? overlays : (overlays && overlays.text ? [overlays] : []);
                const overlayText = overlayList.map(o => o.text).filter(Boolean).join(' | ');

                try {
                    // Generate 3 variations by making 3 API calls
                    const variations = [];
                    for (let i = 0; i < 3; i++) {
                        console.log(`[DEBUG] API Call ${i + 1}/3 - Platform: "${capitalizePlatform(img.platform)}", SizeName: "${baseSizeName}"`);
                        const response = await fetch('/api/generate-ad-copy', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                platform: img.platform,
                                sizeName: baseSizeName, // Use base size name without variation
                                campaignText: campaignText,
                                textOverlay: overlayText,
                                provider: provider
                            })
                        });

                        const result = await response.json();
                        if (result.success && result.adCopy) {
                            console.log(`[DEBUG] API returned copy variation ${i + 1}:`, result.adCopy.headline?.substring(0, 50));
                            variations.push(result.adCopy);
                        }

                        // Small delay between requests
                        await new Promise(resolve => setTimeout(resolve, 300));
                    }

                    // Apply the same variations to all images in this size group
                    console.log(`[DEBUG] Applying ${variations.length} variations to ${indices.length} image indices:`, indices);
                    indices.forEach(index => {
                        console.log(`[DEBUG] Setting adCopyVariations[${index}] (${generatedImages[index].size})`);
                        adCopyVariations[index] = variations;

                        // Initialize selected copy (default to first variation)
                        if (!selectedAdCopy[index]) {
                            selectedAdCopy[index] = {
                                headline: variations[0]?.headline || '',
                                body: variations[0]?.body || '',
                                description: variations[0]?.description || '',
                                cta: variations[0]?.cta || ''
                            };
                        }

                        // Render the ad copy UI
                        renderAdCopyUI(index, variations);
                    });

                } catch (error) {
                    console.error(`Error generating ad copy for ${capitalizePlatform(img.platform)} ${baseSizeName}:`, error);
                    indices.forEach(index => {
                        document.getElementById(`ad-copy-container-${index}`).innerHTML = `
                            <p style="color: #D73D4F;">‚ö†Ô∏è Failed to generate ad copy</p>
                            <p style="color: #A9C1CB; font-size: 0.9rem; margin-top: 0.5rem;">${error.message}</p>
                        `;
                    });
                }

                // Delay between size groups
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        }

        async function regenerateAllAdCopy() {
            const btn = document.getElementById('regenerateAllCopyBtn');
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Regenerating...';

            // Clear existing variations
            adCopyVariations = {};
            selectedAdCopy = {};

            // Re-render the page with loading states
            renderAdCopyPage();

            btn.disabled = false;
            btn.innerHTML = 'üîÑ Regenerate All Copy';
        }

        function renderAdCopyUI(index, variations) {
            const container = document.getElementById(`ad-copy-container-${index}`);
            if (!container || !variations || variations.length === 0) return;

            const img = generatedImages[index];
            const platform = img.platform.toLowerCase();

            // Platform-specific terminology
            const terminology = {
                'meta': {
                    headline: 'Headline',
                    headlineLimit: '(max 27 chars)',
                    body: 'Primary Text',
                    bodyLimit: '(first 125 chars visible)',
                    description: 'Description',
                    descriptionLimit: '(max 27 chars)',
                    hasDescription: true,
                    cta: 'Call-to-Action'
                },
                'reddit': {
                    headline: 'Headline',
                    headlineLimit: '(max 300 chars)',
                    body: 'Body Text',
                    bodyLimit: '(max 500 chars)',
                    hasDescription: false,
                    cta: 'Call-to-Action'
                },
                'pinterest': {
                    headline: 'Pin Title',
                    headlineLimit: '(max 100 chars, first 40 visible)',
                    body: 'Description',
                    bodyLimit: '(max 500 chars)',
                    hasDescription: false,
                    cta: 'Call-to-Action'
                }
            };

            const terms = terminology[platform] || terminology['meta'];

            container.innerHTML = `
                <!-- Headline Section -->
                <div style="margin-bottom: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <h4 style="color: #31D7CA; font-size: 0.9rem; text-transform: uppercase; margin: 0;">${terms.headline} <span style="font-size: 0.75rem; color: #A9C1CB; font-weight: normal; text-transform: none;">${terms.headlineLimit}</span></h4>
                        <button onclick="regenerateHeadline(${index})"
                                style="padding: 0.4rem 0.8rem; border: 2px solid #31D7CA; border-radius: 6px; background: white; color: #31D7CA; cursor: pointer; font-size: 0.85rem; font-weight: 600;">
                            üîÑ Regenerate
                        </button>
                    </div>
                    <textarea id="headline-edit-${index}"
                              style="width: 100%; padding: 0.75rem; border: 2px solid #E1E7EF; border-radius: 8px; font-size: 1rem; font-weight: 600; min-height: 60px; font-family: inherit; resize: vertical;"
                              oninput="updateSelectedAdCopy(${index})">${selectedAdCopy[index]?.headline || ''}</textarea>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; margin-top: 0.5rem;">
                        ${variations.map((v, i) => `
                            <button onclick="selectHeadline(${index}, ${i})"
                                    style="padding: 0.5rem; border: 2px solid ${selectedAdCopy[index]?.headline === v.headline ? '#31D7CA' : '#E1E7EF'}; border-radius: 6px; background: white; cursor: pointer; font-size: 0.85rem; text-align: left;">
                                <strong>Option ${i + 1}</strong><br/>
                                <span style="color: #7DA3AF; font-size: 0.8rem;">${v.headline?.substring(0, 40)}...</span>
                            </button>
                        `).join('')}
                    </div>
                </div>

                <!-- Body Section -->
                <div style="margin-bottom: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <h4 style="color: #31D7CA; font-size: 0.9rem; text-transform: uppercase; margin: 0;">${terms.body} <span style="font-size: 0.75rem; color: #A9C1CB; font-weight: normal; text-transform: none;">${terms.bodyLimit}</span></h4>
                        <button onclick="regenerateBody(${index})"
                                style="padding: 0.4rem 0.8rem; border: 2px solid #31D7CA; border-radius: 6px; background: white; color: #31D7CA; cursor: pointer; font-size: 0.85rem; font-weight: 600;">
                            üîÑ Regenerate
                        </button>
                    </div>
                    <textarea id="body-edit-${index}"
                              style="width: 100%; padding: 0.75rem; border: 2px solid #E1E7EF; border-radius: 8px; font-size: 0.95rem; min-height: 120px; font-family: inherit; line-height: 1.5; resize: vertical;"
                              oninput="updateSelectedAdCopy(${index})">${selectedAdCopy[index]?.body || ''}</textarea>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; margin-top: 0.5rem;">
                        ${variations.map((v, i) => `
                            <button onclick="selectBody(${index}, ${i})"
                                    style="padding: 0.5rem; border: 2px solid ${selectedAdCopy[index]?.body === v.body ? '#31D7CA' : '#E1E7EF'}; border-radius: 6px; background: white; cursor: pointer; font-size: 0.85rem; text-align: left;">
                                <strong>Option ${i + 1}</strong><br/>
                                <span style="color: #7DA3AF; font-size: 0.8rem;">${v.body?.substring(0, 40)}...</span>
                            </button>
                        `).join('')}
                    </div>
                </div>

                ${terms.hasDescription ? `
                <!-- Description Section (Meta only) -->
                <div style="margin-bottom: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <h4 style="color: #31D7CA; font-size: 0.9rem; text-transform: uppercase; margin: 0;">${terms.description} <span style="font-size: 0.75rem; color: #A9C1CB; font-weight: normal; text-transform: none;">${terms.descriptionLimit}</span></h4>
                        <button onclick="regenerateDescription(${index})"
                                style="padding: 0.4rem 0.8rem; border: 2px solid #31D7CA; border-radius: 6px; background: white; color: #31D7CA; cursor: pointer; font-size: 0.85rem; font-weight: 600;">
                            üîÑ Regenerate
                        </button>
                    </div>
                    <textarea id="description-edit-${index}"
                              style="width: 100%; padding: 0.75rem; border: 2px solid #E1E7EF; border-radius: 8px; font-size: 0.95rem; min-height: 60px; font-family: inherit; resize: vertical;"
                              oninput="updateSelectedAdCopy(${index})">${selectedAdCopy[index]?.description || ''}</textarea>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; margin-top: 0.5rem;">
                        ${variations.map((v, i) => `
                            <button onclick="selectDescription(${index}, ${i})"
                                    style="padding: 0.5rem; border: 2px solid ${selectedAdCopy[index]?.description === v.description ? '#31D7CA' : '#E1E7EF'}; border-radius: 6px; background: white; cursor: pointer; font-size: 0.85rem; text-align: left;">
                                <strong>Option ${i + 1}</strong><br/>
                                <span style="color: #7DA3AF; font-size: 0.8rem;">${v.description?.substring(0, 40) || 'N/A'}...</span>
                            </button>
                        `).join('')}
                    </div>
                </div>
                ` : ''}

                <!-- CTA Section -->
                <div style="margin-bottom: 1rem;">
                    <h4 style="color: #31D7CA; margin-bottom: 0.5rem; font-size: 0.9rem; text-transform: uppercase;">${terms.cta}</h4>
                    <input type="text" id="cta-edit-${index}"
                           value="${selectedAdCopy[index]?.cta || ''}"
                           style="width: 100%; padding: 0.75rem; border: 2px solid #E1E7EF; border-radius: 8px; font-size: 0.95rem; font-weight: 600; font-family: inherit;"
                           oninput="updateSelectedAdCopy(${index})">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; margin-top: 0.5rem;">
                        ${variations.map((v, i) => `
                            <button onclick="selectCTA(${index}, ${i})"
                                    style="padding: 0.5rem; border: 2px solid ${selectedAdCopy[index]?.cta === v.cta ? '#31D7CA' : '#E1E7EF'}; border-radius: 6px; background: white; cursor: pointer; font-size: 0.85rem; text-align: center;">
                                <strong>Option ${i + 1}</strong><br/>
                                <span style="color: #FC883A; font-weight: 600;">${v.cta || 'N/A'}</span>
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function selectHeadline(index, variationIndex) {
            const variation = adCopyVariations[index][variationIndex];
            selectedAdCopy[index].headline = variation.headline;
            document.getElementById(`headline-edit-${index}`).value = variation.headline;
            renderAdCopyUI(index, adCopyVariations[index]);
        }

        function selectBody(index, variationIndex) {
            const variation = adCopyVariations[index][variationIndex];
            selectedAdCopy[index].body = variation.body;
            document.getElementById(`body-edit-${index}`).value = variation.body;
            renderAdCopyUI(index, adCopyVariations[index]);
        }

        function selectDescription(index, variationIndex) {
            const variation = adCopyVariations[index][variationIndex];
            selectedAdCopy[index].description = variation.description;
            document.getElementById(`description-edit-${index}`).value = variation.description || '';
            renderAdCopyUI(index, adCopyVariations[index]);
        }

        function selectCTA(index, variationIndex) {
            const variation = adCopyVariations[index][variationIndex];
            selectedAdCopy[index].cta = variation.cta;
            document.getElementById(`cta-edit-${index}`).value = variation.cta;
            renderAdCopyUI(index, adCopyVariations[index]);
        }

        function updateSelectedAdCopy(index) {
            const img = generatedImages[index];
            const platform = img.platform.toLowerCase();

            const adCopy = {
                headline: document.getElementById(`headline-edit-${index}`).value,
                body: document.getElementById(`body-edit-${index}`).value,
                cta: document.getElementById(`cta-edit-${index}`).value
            };

            // Add description for Meta ads
            if (platform === 'meta') {
                const descEl = document.getElementById(`description-edit-${index}`);
                if (descEl) {
                    adCopy.description = descEl.value;
                }
            }

            selectedAdCopy[index] = adCopy;
        }

        async function regenerateHeadline(index) {
            const campaignText = document.getElementById('campaignText').value;
            const provider = document.getElementById('aiProvider').value;
            const img = generatedImages[index];
            const overlays = textOverlays[index];
            const overlayList = Array.isArray(overlays) ? overlays : (overlays && overlays.text ? [overlays] : []);
            const overlayText = overlayList.map(o => o.text).filter(Boolean).join(' | ');
            const baseSizeName = img.size.replace(/\s*-\s*Variation\s+\d+/, '');

            try {
                // Generate 3 new variations for headline only
                const newVariations = [];
                for (let i = 0; i < 3; i++) {
                    const response = await fetch('/api/generate-ad-copy', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            platform: img.platform,
                            sizeName: baseSizeName,
                            campaignText: campaignText,
                            textOverlay: overlayText,
                            provider: provider
                        })
                    });

                    const result = await response.json();
                    if (result.success && result.adCopy) {
                        newVariations.push(result.adCopy);
                    }

                    await new Promise(resolve => setTimeout(resolve, 300));
                }

                // Replace headline variations, keep body and cta
                adCopyVariations[index] = adCopyVariations[index].map((v, i) => ({
                    headline: newVariations[i]?.headline || v.headline,
                    body: v.body,
                    cta: v.cta
                }));

                // Update selected headline to first new option
                selectedAdCopy[index].headline = newVariations[0]?.headline || selectedAdCopy[index].headline;
                document.getElementById(`headline-edit-${index}`).value = selectedAdCopy[index].headline;

                // Re-render UI
                renderAdCopyUI(index, adCopyVariations[index]);

            } catch (error) {
                console.error(`Error regenerating headline:`, error);
                alert('Failed to regenerate headline: ' + error.message);
            }
        }

        async function regenerateBody(index) {
            const campaignText = document.getElementById('campaignText').value;
            const provider = document.getElementById('aiProvider').value;
            const img = generatedImages[index];
            const overlays = textOverlays[index];
            const overlayList = Array.isArray(overlays) ? overlays : (overlays && overlays.text ? [overlays] : []);
            const overlayText = overlayList.map(o => o.text).filter(Boolean).join(' | ');
            const baseSizeName = img.size.replace(/\s*-\s*Variation\s+\d+/, '');

            try {
                // Generate 3 new variations for body only
                const newVariations = [];
                for (let i = 0; i < 3; i++) {
                    const response = await fetch('/api/generate-ad-copy', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            platform: img.platform,
                            sizeName: baseSizeName,
                            campaignText: campaignText,
                            textOverlay: overlayText,
                            provider: provider
                        })
                    });

                    const result = await response.json();
                    if (result.success && result.adCopy) {
                        newVariations.push(result.adCopy);
                    }

                    await new Promise(resolve => setTimeout(resolve, 300));
                }

                // Replace body variations, keep headline and cta
                adCopyVariations[index] = adCopyVariations[index].map((v, i) => ({
                    headline: v.headline,
                    body: newVariations[i]?.body || v.body,
                    cta: v.cta
                }));

                // Update selected body to first new option
                selectedAdCopy[index].body = newVariations[0]?.body || selectedAdCopy[index].body;
                document.getElementById(`body-edit-${index}`).value = selectedAdCopy[index].body;

                // Re-render UI
                renderAdCopyUI(index, adCopyVariations[index]);

            } catch (error) {
                console.error(`Error regenerating body:`, error);
                alert('Failed to regenerate body: ' + error.message);
            }
        }

        async function regenerateDescription(index) {
            const campaignText = document.getElementById('campaignText').value;
            const provider = document.getElementById('aiProvider').value;
            const img = generatedImages[index];
            const overlays = textOverlays[index];
            const overlayList = Array.isArray(overlays) ? overlays : (overlays && overlays.text ? [overlays] : []);
            const overlayText = overlayList.map(o => o.text).filter(Boolean).join(' | ');
            const baseSizeName = img.size.replace(/\s*-\s*Variation\s+\d+/, '');

            try {
                // Generate 3 new variations for description only
                const newVariations = [];
                for (let i = 0; i < 3; i++) {
                    const response = await fetch('/api/generate-ad-copy', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            platform: img.platform,
                            sizeName: baseSizeName,
                            campaignText: campaignText,
                            textOverlay: overlayText,
                            provider: provider
                        })
                    });

                    const result = await response.json();
                    if (result.success && result.adCopy) {
                        newVariations.push(result.adCopy);
                    }

                    await new Promise(resolve => setTimeout(resolve, 300));
                }

                // Replace description variations, keep headline, body and cta
                adCopyVariations[index] = adCopyVariations[index].map((v, i) => ({
                    headline: v.headline,
                    body: v.body,
                    description: newVariations[i]?.description || v.description,
                    cta: v.cta
                }));

                // Update selected description to first new option
                selectedAdCopy[index].description = newVariations[0]?.description || selectedAdCopy[index].description;
                document.getElementById(`description-edit-${index}`).value = selectedAdCopy[index].description || '';

                // Re-render UI
                renderAdCopyUI(index, adCopyVariations[index]);

            } catch (error) {
                console.error(`Error regenerating description:`, error);
                alert('Failed to regenerate description: ' + error.message);
            }
        }

        function renderFinalReviewPage() {
            const finalReviewGrid = document.getElementById('finalReviewGrid');
            finalReviewGrid.innerHTML = '';

            generatedImages.forEach((img, index) => {
                const adCopy = selectedAdCopy[index] || { headline: '', body: '', cta: '' };
                const overlay = textOverlays[index] || {};
                const logo = logoSettings[index] || {};
                const platform = img.platform.toLowerCase();

                // Platform-specific terminology (same as ad copy page)
                const terminology = {
                    'meta': {
                        headline: 'Headline',
                        body: 'Primary Text',
                        description: 'Description',
                        hasDescription: true,
                        cta: 'Call-to-Action'
                    },
                    'reddit': {
                        headline: 'Headline',
                        body: 'Body Text',
                        hasDescription: false,
                        cta: 'Call-to-Action'
                    },
                    'pinterest': {
                        headline: 'Pin Title',
                        body: 'Description',
                        hasDescription: false,
                        cta: 'Call-to-Action'
                    }
                };

                const terms = terminology[platform] || terminology['meta'];

                const card = document.createElement('div');
                card.style.cssText = 'border: 2px solid #E1E7EF; border-radius: 12px; padding: 2rem; background: white;';

                card.innerHTML = `
                    <h3 style="margin-bottom: 1rem; color: #272D3F;">${capitalizePlatform(img.platform)} - ${img.size}</h3>
                    <p style="color: #7DA3AF; font-size: 0.9rem; margin-bottom: 1.5rem;">${img.width}x${img.height}</p>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <!-- Image Preview -->
                        <div>
                            <div style="position: relative; border: 2px solid #E1E7EF; border-radius: 8px; overflow: hidden;">
                                <img src="${img.url}" alt="${capitalizePlatform(img.platform)} ${img.size}" style="width: 100%; display: block;">
                                <div id="review-text-${index}" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none;"></div>
                                <div id="review-logo-${index}" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none;"></div>
                            </div>
                            <button class="btn-secondary" onclick="downloadFinalImage(${index})" style="width: 100%; margin-top: 1rem;">
                                üì• Download This Ad
                            </button>
                        </div>

                        <!-- Ad Copy -->
                        <div>
                            <div style="background: #F4F7FC; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                                <h4 style="color: #31D7CA; font-size: 0.85rem; text-transform: uppercase; margin-bottom: 0.5rem;">${terms.headline}</h4>
                                <p style="font-weight: 600; font-size: 1rem; line-height: 1.4; color: #272D3F;">${adCopy.headline || 'No headline'}</p>
                            </div>

                            <div style="background: #F4F7FC; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                                <h4 style="color: #31D7CA; font-size: 0.85rem; text-transform: uppercase; margin-bottom: 0.5rem;">${terms.body}</h4>
                                <p style="font-size: 0.95rem; line-height: 1.6; color: #272D3F;">${adCopy.body || 'No body copy'}</p>
                            </div>

                            ${terms.hasDescription && adCopy.description ? `
                            <div style="background: #F4F7FC; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                                <h4 style="color: #31D7CA; font-size: 0.85rem; text-transform: uppercase; margin-bottom: 0.5rem;">${terms.description}</h4>
                                <p style="font-size: 0.95rem; line-height: 1.6; color: #272D3F;">${adCopy.description}</p>
                            </div>
                            ` : ''}

                            <div style="background: #F4F7FC; padding: 1.5rem; border-radius: 8px;">
                                <h4 style="color: #31D7CA; font-size: 0.85rem; text-transform: uppercase; margin-bottom: 0.5rem;">${terms.cta}</h4>
                                <p style="font-weight: 600; font-size: 1rem; color: #FC883A;">${adCopy.cta || 'No CTA'}</p>
                            </div>
                        </div>
                    </div>
                `;

                finalReviewGrid.appendChild(card);

                // Render text overlay and logo preview
                setTimeout(() => renderReviewPreview(index), 100);
            });
        }

        function renderReviewPreview(index) {
            const overlays = textOverlays[index];
            const logo = logoSettings[index];

            // Render text overlays - handle both array and single object format
            const textPreview = document.getElementById(`review-text-${index}`);
            const overlayList = Array.isArray(overlays) ? overlays : (overlays && overlays.text ? [overlays] : []);

            if (overlayList.length > 0) {
                let html = '';
                overlayList.forEach(overlay => {
                    if (!overlay || !overlay.text) return;

                    const positionStyles = `top: ${overlay.y || 85}%; left: ${overlay.x || 50}%; transform: translate(-50%, -50%);`;
                    const bgStyle = overlay.bgColor === 'none' ? 'background: transparent;' : `background: ${overlay.bgColor};`;

                    html += `
                        <div style="position: absolute; ${positionStyles}">
                            <div style="display: inline-block; ${bgStyle} padding: 10px 20px; border-radius: 8px; text-align: center;">
                                <p style="color: ${overlay.textColor || '#FFFFFF'}; font-family: '${overlay.fontFamily || 'Gilroy'}', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: ${overlay.fontSize || 28}px; font-weight: 700; margin: 0; line-height: 1.3; white-space: pre-line;">${overlay.text}</p>
                            </div>
                        </div>
                    `;
                });
                textPreview.innerHTML = html;
            }

            // Render logo
            const logoPreview = document.getElementById(`review-logo-${index}`);
            const selectedLogo = availableLogos[logo?.selectedLogoIndex || 0];
            if (logo && logo.enabled && selectedLogo) {
                const positionStyles = `top: ${logo.y}%; left: ${logo.x}%; transform: translate(-50%, -50%);`;
                logoPreview.innerHTML = `
                    <div style="position: absolute; ${positionStyles}">
                        <img src="${selectedLogo.url}" alt="${selectedLogo.name}" style="width: ${logo.scale}%; height: auto; display: block; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));">
                    </div>
                `;
            }
        }

        function exportAllCopy() {
            let copyText = 'BriteCo Ad Campaign - Copy Export (Selected Options)\n';
            copyText += '='.repeat(50) + '\n\n';

            generatedImages.forEach((img, index) => {
                const adCopy = selectedAdCopy[index] || { headline: '', body: '', cta: '' };
                const platform = img.platform.toLowerCase();

                copyText += `${capitalizePlatform(img.platform)} - ${img.size} (${img.width}x${img.height})\n`;
                copyText += '-'.repeat(50) + '\n';
                copyText += `Headline: ${adCopy.headline || 'N/A'}\n\n`;
                copyText += `Body: ${adCopy.body || 'N/A'}\n\n`;

                // Add description for Meta ads
                if (platform === 'meta' && adCopy.description) {
                    copyText += `Description: ${adCopy.description}\n\n`;
                }

                copyText += `CTA: ${adCopy.cta || 'N/A'}\n\n`;
                copyText += '='.repeat(50) + '\n\n';
            });

            // Create downloadable text file
            const blob = new Blob([copyText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'briteco-ad-copy-selected.txt';
            link.click();
            URL.revokeObjectURL(url);
        }

        function exportAllCopyOptions() {
            let copyText = 'BriteCo Ad Campaign - All Copy Options\n';
            copyText += '='.repeat(50) + '\n\n';

            // Group by base size
            const sizeGroups = {};
            generatedImages.forEach((img, index) => {
                const baseSizeName = img.size.replace(/\s*-\s*Variation\s+\d+/, '');
                if (!sizeGroups[baseSizeName]) {
                    sizeGroups[baseSizeName] = {
                        img: img,
                        variations: adCopyVariations[index] || []
                    };
                }
            });

            // Export all variations for each size
            Object.entries(sizeGroups).forEach(([baseSizeName, data]) => {
                const img = data.img;
                const variations = data.variations;
                const platform = img.platform.toLowerCase();

                copyText += `${capitalizePlatform(img.platform)} - ${baseSizeName} (${img.width}x${img.height})\n`;
                copyText += '='.repeat(50) + '\n\n';

                variations.forEach((adCopy, i) => {
                    copyText += `OPTION ${i + 1}:\n`;
                    copyText += '-'.repeat(50) + '\n';
                    copyText += `Headline: ${adCopy.headline || 'N/A'}\n\n`;
                    copyText += `Body: ${adCopy.body || 'N/A'}\n\n`;

                    // Add description for Meta ads
                    if (platform === 'meta' && adCopy.description) {
                        copyText += `Description: ${adCopy.description}\n\n`;
                    }

                    copyText += `CTA: ${adCopy.cta || 'N/A'}\n\n`;
                });

                copyText += '='.repeat(50) + '\n\n';
            });

            // Create downloadable text file
            const blob = new Blob([copyText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'briteco-ad-copy-all-options.txt';
            link.click();
            URL.revokeObjectURL(url);
        }

        // Download ad image (alias for downloadFinalImage - used in logo placement step)
        async function downloadAdImage(index) {
            await downloadFinalImage(index);
        }

        async function downloadFinalImage(index) {
            const img = generatedImages[index];
            const overlays = textOverlays[index];
            const logo = logoSettings[index] || { enabled: false, x: 10, y: 10, scale: 30 };

            // Create canvas
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');

            // Load base image
            const baseImage = new Image();
            baseImage.crossOrigin = 'anonymous';

            baseImage.onload = async function() {
                // Draw base image
                ctx.drawImage(baseImage, 0, 0, img.width, img.height);

                // Draw text overlays - handle both array and single object format
                const overlayList = Array.isArray(overlays) ? overlays : (overlays && overlays.text ? [overlays] : []);

                overlayList.forEach(overlay => {
                    if (!overlay || !overlay.text) return;

                    const x = (overlay.x / 100) * img.width;
                    const y = (overlay.y / 100) * img.height;

                    // Calculate font size proportional to image size
                    const scaleFactor = img.width / 1080; // Relative to standard width
                    const fontSize = (overlay.fontSize || 28) * scaleFactor;

                    ctx.font = `700 ${fontSize}px '${overlay.fontFamily || 'Gilroy'}', Arial, sans-serif`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';

                    // Handle multi-line text
                    const lines = overlay.text.split('\n');
                    const lineHeight = fontSize * 1.3;

                    // Measure max text width for background
                    let maxWidth = 0;
                    lines.forEach(line => {
                        const metrics = ctx.measureText(line);
                        if (metrics.width > maxWidth) maxWidth = metrics.width;
                    });

                    const padding = 20 * scaleFactor;

                    // Draw background if not 'none'
                    if (overlay.bgColor && overlay.bgColor !== 'none') {
                        ctx.fillStyle = overlay.bgColor;
                        const borderRadius = 8 * scaleFactor;
                        const bgHeight = lineHeight * lines.length + padding;
                        const bgX = x - maxWidth / 2 - padding;
                        const bgY = y - bgHeight / 2;
                        const bgWidth = maxWidth + padding * 2;

                        // Draw rounded rectangle
                        ctx.beginPath();
                        ctx.moveTo(bgX + borderRadius, bgY);
                        ctx.lineTo(bgX + bgWidth - borderRadius, bgY);
                        ctx.quadraticCurveTo(bgX + bgWidth, bgY, bgX + bgWidth, bgY + borderRadius);
                        ctx.lineTo(bgX + bgWidth, bgY + bgHeight - borderRadius);
                        ctx.quadraticCurveTo(bgX + bgWidth, bgY + bgHeight, bgX + bgWidth - borderRadius, bgY + bgHeight);
                        ctx.lineTo(bgX + borderRadius, bgY + bgHeight);
                        ctx.quadraticCurveTo(bgX, bgY + bgHeight, bgX, bgY + bgHeight - borderRadius);
                        ctx.lineTo(bgX, bgY + borderRadius);
                        ctx.quadraticCurveTo(bgX, bgY, bgX + borderRadius, bgY);
                        ctx.closePath();
                        ctx.fill();
                    }

                    // Draw text - each line
                    ctx.fillStyle = overlay.textColor || '#FFFFFF';
                    const totalHeight = lineHeight * (lines.length - 1);
                    lines.forEach((line, lineIdx) => {
                        const lineY = y - totalHeight / 2 + lineIdx * lineHeight;
                        ctx.fillText(line, x, lineY);
                    });
                });

                // Draw logo if enabled
                const selectedLogo = availableLogos[logo.selectedLogoIndex || 0];
                console.log('[DOWNLOAD] Logo settings:', logo);
                console.log('[DOWNLOAD] Selected logo:', selectedLogo);

                if (logo.enabled && selectedLogo) {
                    const logoImage = new Image();
                    logoImage.crossOrigin = 'anonymous';

                    logoImage.onerror = function() {
                        console.error('[DOWNLOAD] Failed to load logo, downloading without logo');
                        // Download without logo on error
                        canvas.toBlob(function(blob) {
                            const url = URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            link.href = url;
                            link.download = `${capitalizePlatform(img.platform)}_${img.size}_final.jpg`;
                            link.click();
                            URL.revokeObjectURL(url);
                        }, 'image/jpeg', 0.95);
                    };

                    logoImage.onload = function() {
                        console.log('[DOWNLOAD] Logo loaded successfully, drawing...');
                        const logoWidth = (logo.scale / 100) * img.width;
                        const logoHeight = (logoImage.height / logoImage.width) * logoWidth;

                        // Calculate position from percentage with center anchoring
                        let logoX = (logo.x / 100) * img.width - logoWidth / 2;
                        let logoY = (logo.y / 100) * img.height - logoHeight / 2;

                        // Constrain logo to stay within image bounds
                        logoX = Math.max(0, Math.min(logoX, img.width - logoWidth));
                        logoY = Math.max(0, Math.min(logoY, img.height - logoHeight));

                        // Add subtle drop shadow for logo
                        ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
                        ctx.shadowBlur = 4;
                        ctx.shadowOffsetX = 0;
                        ctx.shadowOffsetY = 2;

                        ctx.drawImage(logoImage, logoX, logoY, logoWidth, logoHeight);

                        // Reset shadow
                        ctx.shadowColor = 'transparent';
                        ctx.shadowBlur = 0;
                        ctx.shadowOffsetX = 0;
                        ctx.shadowOffsetY = 0;

                        // Download composited image
                        canvas.toBlob(function(blob) {
                            const url = URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            link.href = url;
                            link.download = `${capitalizePlatform(img.platform)}_${img.size}_final.jpg`;
                            link.click();
                            URL.revokeObjectURL(url);
                        }, 'image/jpeg', 0.95);
                    };

                    console.log('[DOWNLOAD] Loading logo from:', selectedLogo.url);
                    logoImage.src = selectedLogo.url;
                } else {
                    // No logo, just download with text
                    canvas.toBlob(function(blob) {
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `${capitalizePlatform(img.platform)}_${img.size}_final.jpg`;
                        link.click();
                        URL.revokeObjectURL(url);
                    }, 'image/jpeg', 0.95);
                }
            };

            baseImage.src = img.url;
        }

        function downloadAll() {
            generatedImages.forEach((img, index) => {
                setTimeout(() => {
                    downloadFinalImage(index);
                }, index * 500); // Stagger downloads
            });
        }

        // GIF Creation Page Functions
        let selectedGifs = new Set();
        let gifSettings = {}; // Store settings for each GIF
        let gifResults = []; // Store generated GIFs with frames for editing

        function goToGifCreation() {
            document.getElementById('step8').classList.add('hidden');
            document.getElementById('step9').classList.remove('hidden');
            currentStep = 9;
            window.scrollTo({ top: 0, behavior: 'smooth' });
            renderGifSelection();

            // Update back button text
            const backBtn = document.getElementById('backFromGifBtn');
            if (backBtn) {
                backBtn.textContent = '‚Üê Back to Review';
            }
        }

        function backToFinalReview() {
            document.getElementById('step9').classList.add('hidden');
            document.getElementById('step10').classList.add('hidden');

            // For General Image flow, go back to General Preview
            if (isGeneralImageOnly()) {
                document.getElementById('stepGeneralPreview').classList.remove('hidden');
                currentStep = 9;
            } else if (skippedCopyFlow) {
                // User skipped copy, go back to preview page
                document.getElementById('stepPreview').classList.remove('hidden');
                currentStep = 'preview';
            } else {
                document.getElementById('step8').classList.remove('hidden');
                currentStep = 8;
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function renderGifSelection() {
            const grid = document.getElementById('gifSelectionGrid');
            grid.innerHTML = '';

            generatedImages.forEach((img, index) => {
                const isSelected = selectedGifs.has(index);

                // Initialize default settings
                if (!gifSettings[index]) {
                    gifSettings[index] = {
                        frameCount: 5,
                        fps: 2  // 2 frames per second by default
                    };
                }

                const card = document.createElement('div');
                card.style.cssText = `
                    border: 3px solid ${isSelected ? '#31D7CA' : '#E1E7EF'};
                    border-radius: 12px;
                    padding: 1rem;
                    background: white;
                    cursor: pointer;
                    transition: all 0.2s ease;
                `;

                card.innerHTML = `
                    <div style="position: relative;">
                        <input type="checkbox"
                               id="gif-select-${index}"
                               ${isSelected ? 'checked' : ''}
                               onchange="toggleGifSelection(${index}, this.checked)"
                               style="position: absolute; top: 0.5rem; left: 0.5rem; width: 24px; height: 24px; cursor: pointer; z-index: 10;">
                        <img src="${img.url}" style="width: 100%; border-radius: 8px; margin-bottom: 1rem;">
                    </div>
                    <h4 style="margin-bottom: 0.5rem; color: #272D3F;">${capitalizePlatform(img.platform)} - ${img.size}</h4>
                    <p style="color: #7DA3AF; font-size: 0.85rem; margin-bottom: 1rem;">${img.width}x${img.height}</p>

                    <div class="gif-settings-${index}" style="display: ${isSelected ? 'block' : 'none'}; padding-top: 1rem; border-top: 1px solid #E1E7EF;">
                        <label style="display: block; font-size: 0.85rem; color: #7DA3AF; margin-bottom: 0.25rem;">Frame Count:</label>
                        <select id="frame-count-${index}" onchange="updateGifSetting(${index}, 'frameCount', this.value)"
                                style="width: 100%; padding: 0.5rem; border: 1px solid #E1E7EF; border-radius: 6px;">
                            <option value="3" ${gifSettings[index].frameCount === 3 ? 'selected' : ''}>3 frames</option>
                            <option value="4" ${gifSettings[index].frameCount === 4 ? 'selected' : ''}>4 frames</option>
                            <option value="5" ${gifSettings[index].frameCount === 5 ? 'selected' : ''}>5 frames (recommended)</option>
                            <option value="6" ${gifSettings[index].frameCount === 6 ? 'selected' : ''}>6 frames</option>
                            <option value="7" ${gifSettings[index].frameCount === 7 ? 'selected' : ''}>7 frames</option>
                        </select>
                        <p style="font-size: 0.75rem; color: #7DA3AF; margin-top: 0.5rem;">
                            üí° You can adjust animation speed in the editor after generation
                        </p>
                    </div>
                `;

                card.onclick = (e) => {
                    if (e.target.type !== 'checkbox' && e.target.tagName !== 'SELECT') {
                        const checkbox = document.getElementById(`gif-select-${index}`);
                        checkbox.checked = !checkbox.checked;
                        toggleGifSelection(index, checkbox.checked);
                    }
                };

                grid.appendChild(card);
            });
        }

        function toggleGifSelection(index, isSelected) {
            if (isSelected) {
                selectedGifs.add(index);
            } else {
                selectedGifs.delete(index);
            }
            renderGifSelection();
        }

        function updateGifSetting(index, setting, value) {
            gifSettings[index][setting] = parseInt(value);
            // Update duration display
            const durationDisplay = document.getElementById(`duration-display-${index}`);
            if (durationDisplay) {
                const frameCount = gifSettings[index].frameCount || 5;
                const fps = gifSettings[index].fps || 2;
                durationDisplay.textContent = `Duration: ${(frameCount / fps).toFixed(1)}s`;
            }
        }

        async function generateSelectedGifs() {
            if (selectedGifs.size === 0) {
                alert('Please select at least one ad to animate');
                return;
            }

            // Show loading overlay
            document.getElementById('overlayTitle').textContent = 'Generating Animated GIFs';
            document.getElementById('overlayMessage').textContent = `Creating ${selectedGifs.size} animated GIF${selectedGifs.size > 1 ? 's' : ''}. This may take a few moments...`;
            document.getElementById('loadingOverlay').classList.remove('hidden');

            const basePrompt = document.getElementById('promptText').value;
            let completedCount = 0;

            // Clear previous results
            gifResults = [];

            for (const index of selectedGifs) {
                const img = generatedImages[index];
                const settings = gifSettings[index];

                console.log(`[GIF] Generating animation for index ${index}:`);
                console.log(`  - Frame count requested: ${settings.frameCount}`);
                console.log(`  - FPS: ${settings.fps || 2}`);
                console.log(`  - Dimensions: ${img.width}x${img.height}`);

                try {
                    const requestData = {
                        prompt: basePrompt,
                        width: img.width,
                        height: img.height,
                        frame_count: settings.frameCount,
                        fps: settings.fps || 2,
                        platform: img.platform,
                        sizeName: img.size
                    };
                    console.log('[GIF] Request data:', JSON.stringify(requestData, null, 2));

                    const response = await fetch('/api/generate-animation', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestData)
                    });

                    const result = await response.json();

                    if (result.success) {
                        console.log(`[GIF] Result received:`);
                        console.log(`  - Frames returned: ${result.frames ? result.frames.length : 0}`);
                        console.log(`  - Frame count from server: ${result.frame_count}`);
                        console.log(`  - FPS from server: ${result.fps}`);

                        // Store result with frames for editing
                        gifResults.push({
                            animation: result.animation,
                            frames: result.frames || [],
                            frameCount: result.frame_count,
                            fps: result.fps || settings.fps || 2,
                            platform: img.platform,
                            size: img.size,
                            width: img.width,
                            height: img.height,
                            frameOverlays: result.frames ? result.frames.map(() => ({
                                text: '',
                                position: 'bottom',
                                size: 32,
                                font: 'Gilroy, Arial, sans-serif',
                                color: '#FFFFFF',
                                bgColor: 'rgba(0,0,0,0.7)',
                                showLogo: false,
                                logoIndex: 0,
                                logoPosition: 'bottom-right',
                                logoSize: 15
                            })) : []
                        });
                    } else {
                        console.error(`Failed to generate GIF for ${img.platform} ${img.size}:`, result.error);
                    }
                } catch (error) {
                    console.error(`Error generating GIF for ${img.platform} ${img.size}:`, error);
                }

                completedCount++;
                document.getElementById('overlayMessage').textContent = `Generated ${completedCount} of ${selectedGifs.size} GIFs...`;
            }

            // Hide loading overlay
            document.getElementById('loadingOverlay').classList.add('hidden');

            // Navigate to results page
            goToGifResults();
        }

        function goToGifResults() {
            document.getElementById('step9').classList.add('hidden');
            document.getElementById('step10').classList.remove('hidden');
            currentStep = 10;
            window.scrollTo({ top: 0, behavior: 'smooth' });
            renderGifResults();
        }

        function backToGifSelection() {
            document.getElementById('step10').classList.add('hidden');
            document.getElementById('step9').classList.remove('hidden');
            currentStep = 9;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function renderGifResults() {
            const resultsGrid = document.getElementById('gifResultsGrid');
            resultsGrid.innerHTML = '';

            gifResults.forEach((gifData, gifIndex) => {
                const resultCard = document.createElement('div');
                resultCard.style.cssText = `
                    border: 2px solid #31D7CA;
                    border-radius: 12px;
                    padding: 1.5rem;
                    background: white;
                `;

                resultCard.innerHTML = `
                    <h4 style="margin-bottom: 1rem; color: #272D3F;">${capitalizePlatform(gifData.platform)} - ${gifData.size}</h4>
                    <img src="${gifData.animation}" id="gif-preview-${gifIndex}" style="width: 100%; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button onclick="openFrameEditor(${gifIndex})"
                                class="btn-secondary" style="flex: 1;">
                            ‚úèÔ∏è Edit Frames
                        </button>
                        <button onclick="downloadGifResult('${gifData.animation}', '${capitalizePlatform(gifData.platform)}_${gifData.size}')"
                                class="btn-primary" style="flex: 1;">
                            üì• Download GIF
                        </button>
                    </div>
                    <p style="color: #7DA3AF; font-size: 0.85rem; margin-top: 0.5rem;">
                        ${gifData.frameCount} frames ‚Ä¢ ${gifData.duration}s duration
                    </p>
                `;

                resultsGrid.appendChild(resultCard);
            });
        }

        function downloadGifResult(dataUrl, filename) {
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = `${filename}_animation.gif`;
            link.click();
        }

        // Frame Editor Functions
        let currentGifIndex = null;
        let currentFrameIndex = 0;

        function openFrameEditor(gifIndex) {
            currentGifIndex = gifIndex;
            currentFrameIndex = 0;

            const gifData = gifResults[gifIndex];
            if (!gifData || !gifData.frames || gifData.frames.length === 0) {
                alert('No frames available for editing');
                return;
            }

            document.getElementById('frameEditorModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';

            // Set animation speed slider to current fps
            const fps = gifData.fps || 2;
            document.getElementById('animationSpeedSlider').value = fps;
            document.getElementById('animationSpeedDisplay').textContent = fps;
            updateAnimationDurationDisplay();

            renderFrameThumbnails();
            selectFrame(0);

            // Setup logo drag handler after modal opens
            setTimeout(() => setupFrameLogoDragHandler(), 100);
        }

        function updateAnimationSpeed(fps) {
            document.getElementById('animationSpeedDisplay').textContent = fps;
            const gifData = gifResults[currentGifIndex];
            if (gifData) {
                gifData.fps = parseInt(fps);
            }
            updateAnimationDurationDisplay();
        }

        function updateAnimationDurationDisplay() {
            const gifData = gifResults[currentGifIndex];
            if (gifData) {
                const fps = gifData.fps || 2;
                const frameCount = gifData.frames ? gifData.frames.length : 0;
                const duration = (frameCount / fps).toFixed(1);
                document.getElementById('animationDurationDisplay').textContent =
                    `${frameCount} frames at ${fps} FPS = ${duration}s animation`;
            }
        }

        function closeFrameEditor() {
            document.getElementById('frameEditorModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
            currentGifIndex = null;
            currentFrameIndex = 0;
        }

        function renderFrameThumbnails() {
            const gifData = gifResults[currentGifIndex];
            const thumbnailsContainer = document.getElementById('frameThumbnails');
            thumbnailsContainer.innerHTML = '';

            gifData.frames.forEach((frameUrl, index) => {
                const thumbnail = document.createElement('div');
                thumbnail.style.cssText = `
                    cursor: pointer;
                    border: 3px solid ${index === currentFrameIndex ? '#31D7CA' : '#E1E7EF'};
                    border-radius: 8px;
                    overflow: hidden;
                    flex-shrink: 0;
                    width: 100px;
                    transition: all 0.2s ease;
                `;
                thumbnail.onclick = () => selectFrame(index);

                const img = document.createElement('img');
                img.src = frameUrl;
                img.style.cssText = 'width: 100%; height: auto; display: block;';

                const label = document.createElement('div');
                label.textContent = `Frame ${index + 1}`;
                label.style.cssText = `
                    text-align: center;
                    font-size: 0.75rem;
                    padding: 0.25rem;
                    background: ${index === currentFrameIndex ? '#31D7CA' : '#E1E7EF'};
                    color: ${index === currentFrameIndex ? 'white' : '#7DA3AF'};
                `;

                thumbnail.appendChild(img);
                thumbnail.appendChild(label);
                thumbnailsContainer.appendChild(thumbnail);
            });
        }

        function selectFrame(index) {
            currentFrameIndex = index;
            const gifData = gifResults[currentGifIndex];
            const overlay = gifData.frameOverlays[index];

            // Update form inputs
            renderLogoSelector();
            document.getElementById('frameTextInput').value = overlay.text;
            document.getElementById('framePositionSelect').value = overlay.position;
            document.getElementById('frameFontSelect').value = overlay.font || 'Gilroy, Arial, sans-serif';
            document.getElementById('frameSizeSlider').value = overlay.size;
            document.getElementById('frameSizeDisplay').textContent = overlay.size;
            document.getElementById('frameLogoCheckbox').checked = overlay.showLogo;
            document.getElementById('frameLogoControls').style.display = overlay.showLogo ? 'block' : 'none';
            if (overlay.showLogo) {
                document.getElementById('frameLogoPosition').value = overlay.logoPosition;
                document.getElementById('frameLogoSize').value = overlay.logoSize;
                document.getElementById('frameLogoSizeDisplay').textContent = overlay.logoSize;
            }

            renderFrameThumbnails();
            updateFramePreview();
        }

        function renderLogoSelector() {
            const container = document.getElementById('frameLogoSelector');
            const gifData = gifResults[currentGifIndex];
            const overlay = gifData.frameOverlays[currentFrameIndex];

            container.innerHTML = availableLogos.map((logo, idx) => `
                <div onclick="selectFrameLogo(${idx})"
                     id="frame-logo-${idx}"
                     style="border: 3px solid ${(overlay.logoIndex === idx) ? '#31D7CA' : '#E1E7EF'};
                            border-radius: 6px;
                            padding: 0.25rem;
                            cursor: pointer;
                            transition: all 0.2s ease;
                            background: white;">
                    <img src="${logo.url}" style="width: 100%; height: auto; display: block;" onerror="this.style.display='none'; this.parentElement.innerHTML='<p style=\\'font-size:0.6rem;text-align:center;\\'>Logo ${idx+1}</p>';">
                </div>
            `).join('');
        }

        function selectFrameLogo(logoIndex) {
            const gifData = gifResults[currentGifIndex];
            gifData.frameOverlays[currentFrameIndex].logoIndex = logoIndex;
            renderLogoSelector();
            updateFramePreview();
        }

        function updateFramePreview() {
            const gifData = gifResults[currentGifIndex];
            const frameUrl = gifData.frames[currentFrameIndex];
            const canvas = document.getElementById('framePreviewCanvas');
            const ctx = canvas.getContext('2d');

            const img = new Image();
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;

                // Draw the frame
                ctx.drawImage(img, 0, 0);

                // Get current overlay settings
                const text = document.getElementById('frameTextInput').value;
                const position = document.getElementById('framePositionSelect').value;
                const font = document.getElementById('frameFontSelect').value;
                const size = parseInt(document.getElementById('frameSizeSlider').value);
                const color = gifData.frameOverlays[currentFrameIndex].color;
                const bgColor = gifData.frameOverlays[currentFrameIndex].bgColor;
                const showLogo = document.getElementById('frameLogoCheckbox').checked;
                const logoIndex = gifData.frameOverlays[currentFrameIndex].logoIndex || 0;
                const logoSize = showLogo ? parseInt(document.getElementById('frameLogoSize').value) : 15;
                // Preserve custom logo position if set, otherwise use undefined
                const logoX = gifData.frameOverlays[currentFrameIndex].logoX;
                const logoY = gifData.frameOverlays[currentFrameIndex].logoY;

                // Update overlay in storage (preserve logoX and logoY for drag positioning)
                gifData.frameOverlays[currentFrameIndex] = { text, position, font, size, color, bgColor, showLogo, logoIndex, logoX, logoY, logoSize };

                // Draw text overlay if text exists
                if (text) {
                    ctx.font = `bold ${size}px ${font}`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';

                    // Calculate text position
                    let x = canvas.width / 2;
                    let y;
                    if (position === 'top') {
                        y = size + 20;
                    } else if (position === 'center') {
                        y = canvas.height / 2;
                    } else {
                        y = canvas.height - size - 20;
                    }

                    // Draw background for text
                    const metrics = ctx.measureText(text);
                    const textWidth = metrics.width;
                    const padding = 20;
                    const bgHeight = size + padding;

                    ctx.fillStyle = bgColor;
                    ctx.fillRect(
                        x - textWidth / 2 - padding,
                        y - bgHeight / 2,
                        textWidth + padding * 2,
                        bgHeight
                    );

                    // Draw text
                    ctx.fillStyle = color;
                    ctx.fillText(text, x, y);
                }

                // Draw logo if enabled
                if (showLogo && availableLogos[logoIndex]) {
                    const logoImg = new Image();
                    logoImg.crossOrigin = 'anonymous';
                    logoImg.onload = function() {
                        const logoWidth = (canvas.width * logoSize) / 100;
                        const logoHeight = (logoImg.height / logoImg.width) * logoWidth;

                        let drawX, drawY;
                        const margin = 15;

                        // Use custom position if set via dragging, otherwise default to bottom-right
                        if (logoX !== undefined && logoY !== undefined) {
                            drawX = (logoX / 100) * canvas.width - logoWidth / 2;
                            drawY = (logoY / 100) * canvas.height - logoHeight / 2;
                        } else {
                            // Default position: bottom-right
                            drawX = canvas.width - logoWidth - margin;
                            drawY = canvas.height - logoHeight - margin;
                        }

                        // Store logo bounds for drag detection
                        window.currentLogoBounds = {
                            x: drawX,
                            y: drawY,
                            width: logoWidth,
                            height: logoHeight
                        };

                        ctx.drawImage(logoImg, drawX, drawY, logoWidth, logoHeight);
                    };
                    logoImg.src = availableLogos[logoIndex].url;
                }
            };
            img.src = frameUrl;
        }

        function toggleFrameLogo() {
            const checked = document.getElementById('frameLogoCheckbox').checked;
            document.getElementById('frameLogoControls').style.display = checked ? 'block' : 'none';
            if (checked) {
                setupFrameLogoDragHandler();
            }
            updateFramePreview();
        }

        // Setup drag handler for logo on canvas (GIF frame editor)
        function setupFrameLogoDragHandler() {
            const canvas = document.getElementById('framePreviewCanvas');
            if (!canvas || canvas.logoDragSetup) return;

            let isDragging = false;

            canvas.addEventListener('mousedown', function(e) {
                const gifData = gifResults[currentGifIndex];
                if (!gifData || !gifData.frameOverlays[currentFrameIndex].showLogo) return;

                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                const mouseX = (e.clientX - rect.left) * scaleX;
                const mouseY = (e.clientY - rect.top) * scaleY;

                // Check if click is on logo
                const bounds = window.currentLogoBounds;
                if (bounds &&
                    mouseX >= bounds.x && mouseX <= bounds.x + bounds.width &&
                    mouseY >= bounds.y && mouseY <= bounds.y + bounds.height) {
                    isDragging = true;
                    canvas.style.cursor = 'grabbing';
                    e.preventDefault();
                }
            });

            canvas.addEventListener('mousemove', function(e) {
                if (!isDragging) return;

                const gifData = gifResults[currentGifIndex];
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                const mouseX = (e.clientX - rect.left) * scaleX;
                const mouseY = (e.clientY - rect.top) * scaleY;

                // Convert to percentage
                const percentX = (mouseX / canvas.width) * 100;
                const percentY = (mouseY / canvas.height) * 100;

                // Clamp values
                gifData.frameOverlays[currentFrameIndex].logoX = Math.max(5, Math.min(95, percentX));
                gifData.frameOverlays[currentFrameIndex].logoY = Math.max(5, Math.min(95, percentY));

                updateFramePreview();
            });

            canvas.addEventListener('mouseup', function() {
                if (isDragging) {
                    isDragging = false;
                    canvas.style.cursor = 'default';
                }
            });

            canvas.addEventListener('mouseleave', function() {
                if (isDragging) {
                    isDragging = false;
                    canvas.style.cursor = 'default';
                }
            });

            // Update cursor on hover over logo
            canvas.addEventListener('mousemove', function(e) {
                if (isDragging) return;

                const gifData = gifResults[currentGifIndex];
                if (!gifData || !gifData.frameOverlays[currentFrameIndex].showLogo) return;

                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                const mouseX = (e.clientX - rect.left) * scaleX;
                const mouseY = (e.clientY - rect.top) * scaleY;

                const bounds = window.currentLogoBounds;
                if (bounds &&
                    mouseX >= bounds.x && mouseX <= bounds.x + bounds.width &&
                    mouseY >= bounds.y && mouseY <= bounds.y + bounds.height) {
                    canvas.style.cursor = 'grab';
                } else {
                    canvas.style.cursor = 'default';
                }
            });

            canvas.logoDragSetup = true;
        }

        function setFrameColor(color) {
            const gifData = gifResults[currentGifIndex];
            gifData.frameOverlays[currentFrameIndex].color = color;
            updateFramePreview();
        }

        function setFrameBgColor(bgColor) {
            const gifData = gifResults[currentGifIndex];
            gifData.frameOverlays[currentFrameIndex].bgColor = bgColor;
            updateFramePreview();
        }

        function applyToAllFrames() {
            const gifData = gifResults[currentGifIndex];
            const currentOverlay = gifData.frameOverlays[currentFrameIndex];

            if (!currentOverlay.text && !currentOverlay.showLogo) {
                alert('Please add text or logo before applying to all frames');
                return;
            }

            if (confirm('Apply current overlay settings to all frames?')) {
                gifData.frameOverlays = gifData.frameOverlays.map(() => ({
                    text: currentOverlay.text,
                    position: currentOverlay.position,
                    font: currentOverlay.font,
                    size: currentOverlay.size,
                    color: currentOverlay.color,
                    bgColor: currentOverlay.bgColor,
                    showLogo: currentOverlay.showLogo,
                    logoIndex: currentOverlay.logoIndex,
                    logoX: currentOverlay.logoX,
                    logoY: currentOverlay.logoY,
                    logoSize: currentOverlay.logoSize
                }));
                updateFramePreview();
                alert('Overlay settings applied to all frames!');
            }
        }

        function clearFrameOverlay() {
            const gifData = gifResults[currentGifIndex];
            gifData.frameOverlays[currentFrameIndex] = {
                text: '',
                position: 'bottom',
                size: 32,
                font: 'Gilroy, Arial, sans-serif',
                color: '#FFFFFF',
                bgColor: 'rgba(0,0,0,0.7)',
                showLogo: false,
                logoIndex: 0,
                logoPosition: 'bottom-right',
                logoSize: 15
            };
            document.getElementById('frameTextInput').value = '';
            document.getElementById('frameLogoCheckbox').checked = false;
            document.getElementById('frameLogoControls').style.display = 'none';
            updateFramePreview();
        }

        function deleteCurrentFrame() {
            const gifData = gifResults[currentGifIndex];

            if (gifData.frames.length <= 1) {
                alert('Cannot delete the last frame! A GIF must have at least one frame.');
                return;
            }

            if (!confirm(`Delete frame ${currentFrameIndex + 1}?`)) {
                return;
            }

            // Remove frame and overlay
            gifData.frames.splice(currentFrameIndex, 1);
            gifData.frameOverlays.splice(currentFrameIndex, 1);
            gifData.frameCount = gifData.frames.length;

            // Adjust current frame index if needed
            if (currentFrameIndex >= gifData.frames.length) {
                currentFrameIndex = gifData.frames.length - 1;
            }

            // Re-render
            renderFrameThumbnails();
            selectFrame(currentFrameIndex);
        }

        async function regenerateGifWithOverlays() {
            const gifData = gifResults[currentGifIndex];

            // Check if any frames have overlays
            const hasOverlays = gifData.frameOverlays.some(overlay => overlay.text || overlay.showLogo);
            if (!hasOverlays) {
                alert('Please add text or logo overlays to at least one frame before regenerating');
                return;
            }

            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '‚è≥ Generating GIF...';

            try {
                // Create canvas for each frame with overlay
                const processedFrames = await Promise.all(gifData.frames.map((frameUrl, index) => {
                    return new Promise((resolve) => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const img = new Image();

                        img.onload = function() {
                            canvas.width = img.width;
                            canvas.height = img.height;
                            ctx.drawImage(img, 0, 0);

                            const overlay = gifData.frameOverlays[index];
                            if (overlay.text) {
                                // Draw text overlay
                                ctx.font = `bold ${overlay.size}px Gilroy, Arial, sans-serif`;
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'middle';

                                let x = canvas.width / 2;
                                let y;
                                if (overlay.position === 'top') {
                                    y = overlay.size + 20;
                                } else if (overlay.position === 'center') {
                                    y = canvas.height / 2;
                                } else {
                                    y = canvas.height - overlay.size - 20;
                                }

                                // Background
                                const metrics = ctx.measureText(overlay.text);
                                const textWidth = metrics.width;
                                const padding = 20;
                                const bgHeight = overlay.size + padding;

                                ctx.fillStyle = overlay.bgColor || 'rgba(0, 0, 0, 0.7)';
                                ctx.fillRect(
                                    x - textWidth / 2 - padding,
                                    y - bgHeight / 2,
                                    textWidth + padding * 2,
                                    bgHeight
                                );

                                // Text
                                ctx.fillStyle = overlay.color;
                                ctx.fillText(overlay.text, x, y);
                            }

                            // Draw logo if enabled - use availableLogos array
                            const logoIndex = overlay.logoIndex || 0;
                            if (overlay.showLogo && availableLogos[logoIndex]) {
                                const logoImg = new Image();
                                logoImg.crossOrigin = 'anonymous';
                                logoImg.onload = function() {
                                    const logoWidth = (canvas.width * overlay.logoSize) / 100;
                                    const logoHeight = (logoImg.height / logoImg.width) * logoWidth;

                                    let logoX, logoY;
                                    const margin = 15;

                                    // Support custom position or preset positions
                                    if (overlay.logoX !== undefined && overlay.logoY !== undefined) {
                                        logoX = (overlay.logoX / 100) * canvas.width - logoWidth / 2;
                                        logoY = (overlay.logoY / 100) * canvas.height - logoHeight / 2;
                                    } else if (overlay.logoPosition === 'top-left') {
                                        logoX = margin;
                                        logoY = margin;
                                    } else if (overlay.logoPosition === 'top-right') {
                                        logoX = canvas.width - logoWidth - margin;
                                        logoY = margin;
                                    } else if (overlay.logoPosition === 'bottom-left') {
                                        logoX = margin;
                                        logoY = canvas.height - logoHeight - margin;
                                    } else {
                                        logoX = canvas.width - logoWidth - margin;
                                        logoY = canvas.height - logoHeight - margin;
                                    }

                                    ctx.drawImage(logoImg, logoX, logoY, logoWidth, logoHeight);
                                    resolve(canvas.toDataURL('image/png'));
                                };
                                logoImg.src = availableLogos[logoIndex].url;
                            } else {
                                resolve(canvas.toDataURL('image/png'));
                            }
                        };
                        img.src = frameUrl;
                    });
                }));

                // Use gifshot library or create simple GIF from frames
                // For now, we'll create a simple animation by updating the preview
                // In production, you'd want to use a GIF encoding library

                // Create animated data URL (simplified - in production use proper GIF encoding)
                const newGifData = processedFrames[0]; // For demo, showing first frame

                // Update the GIF preview in results
                const gifPreview = document.getElementById(`gif-preview-${currentGifIndex}`);
                if (gifPreview) {
                    // Store processed frames for download
                    gifData.processedFrames = processedFrames;
                    gifData.processedAnimation = newGifData;

                    // Clear any existing animation interval
                    if (gifPreview.animationInterval) {
                        clearInterval(gifPreview.animationInterval);
                    }

                    // Use the FPS setting for preview animation speed
                    const fps = gifData.fps || 2;
                    const intervalMs = Math.round(1000 / fps);

                    let frameIndex = 0;
                    const cycleFrames = () => {
                        gifPreview.src = processedFrames[frameIndex];
                        frameIndex = (frameIndex + 1) % processedFrames.length;
                    };
                    gifPreview.animationInterval = setInterval(cycleFrames, intervalMs);
                    cycleFrames();
                }

                btn.textContent = '‚úÖ GIF Updated!';
                setTimeout(() => {
                    btn.textContent = '‚ú® Regenerate GIF with Text Overlays';
                    btn.disabled = false;
                }, 2000);

                alert('GIF updated with text overlays! Close the editor to see the result.');
            } catch (error) {
                console.error('Error regenerating GIF:', error);
                alert('Error regenerating GIF. Please try again.');
                btn.textContent = '‚ú® Regenerate GIF with Text Overlays';
                btn.disabled = false;
            }
        }

        function handleLogo(file) {
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadedLogo = e.target.result;
                    document.getElementById('currentLogo').src = uploadedLogo;
                };
                reader.readAsDataURL(file);
            }
        }

        // Initialize logo on page load
        window.addEventListener('DOMContentLoaded', function() {
            // Load BriteCo logo from JPG file
            fetch('logo file for claude.jpg')
                .then(response => response.blob())
                .then(blob => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        uploadedLogo = e.target.result;
                        console.log('[LOGO] BriteCo logo loaded successfully');
                    };
                    reader.readAsDataURL(blob);
                })
                .catch(error => {
                    console.error('[LOGO] Failed to load logo:', error);
                    alert('Warning: Logo file not found. Please ensure "logo file for claude.jpg" exists in the project directory.');
                });
        });

        function updateOverlay(index) {
            const text = document.getElementById(`text-${index}`).value;
            const position = document.getElementById(`position-${index}`).value;
            const size = document.getElementById(`size-${index}`).value;
            const color = document.getElementById(`color-${index}`).value;

            const overlay = document.getElementById(`overlay-${index}`);

            if (text) {
                let positionStyles = '';
                if (position === 'top') {
                    positionStyles = 'top: 20px; left: 0; right: 0; text-align: center;';
                } else if (position === 'center') {
                    positionStyles = 'top: 50%; left: 0; right: 0; transform: translateY(-50%); text-align: center;';
                } else {
                    positionStyles = 'bottom: 20px; left: 0; right: 0; text-align: center;';
                }

                overlay.innerHTML = `
                    <div style="position: absolute; ${positionStyles}">
                        <div style="display: inline-block; background: rgba(0, 0, 0, 0.7); padding: 10px 20px; border-radius: 8px;">
                            <p style="color: ${color}; font-family: 'Gilroy', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: ${size}px; font-weight: 700; margin: 0; text-transform: uppercase; line-height: 1.2;">${text}</p>
                        </div>
                    </div>
                `;
            } else {
                overlay.innerHTML = '';
            }
        }

        function updateLogoOverlay(index) {
            if (!uploadedLogo) return;

            const logoOverlay = document.getElementById(`logo-overlay-${index}`);
            const logoPositionEl = document.getElementById(`logo-position-${index}`);
            const logoSizeEl = document.getElementById(`logo-size-${index}`);
            const logoSizeDisplay = document.getElementById(`logo-size-display-${index}`);

            if (!logoPositionEl) return;

            const logoPosition = logoPositionEl.value;
            const logoSize = logoSizeEl ? logoSizeEl.value : 15;

            if (logoSizeDisplay) {
                logoSizeDisplay.textContent = logoSize;
            }

            if (!logoPosition) {
                logoOverlay.innerHTML = '';
                return;
            }

            let positionStyles = '';
            if (logoPosition === 'top-left') {
                positionStyles = 'top: 15px; left: 15px;';
            } else if (logoPosition === 'top-right') {
                positionStyles = 'top: 15px; right: 15px;';
            } else if (logoPosition === 'bottom-left') {
                positionStyles = 'bottom: 15px; left: 15px;';
            } else if (logoPosition === 'bottom-right') {
                positionStyles = 'bottom: 15px; right: 15px;';
            } else if (logoPosition === 'center') {
                positionStyles = 'top: 50%; left: 50%; transform: translate(-50%, -50%);';
            }

            logoOverlay.innerHTML = `
                <div style="position: absolute; ${positionStyles}">
                    <img src="${uploadedLogo}" alt="Logo" style="width: ${logoSize}%; height: auto; display: block; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));">
                </div>
            `;
        }

        function downloadImageFromUrl(dataUrl, filename) {
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = filename;
            link.click();
        }

        function updateCharCount() {
            const text = document.getElementById('campaignText').value;
            const count = text.length;
            document.getElementById('charCount').textContent = `${count} / 500 characters`;

            if (count > 500) {
                document.getElementById('charCount').style.color = '#D73D4F';
            } else {
                document.getElementById('charCount').style.color = '#A9C1CB';
            }
        }

        function handleFiles(files) {
            console.log('[INSPIRATION] handleFiles called with', files.length, 'files');
            for (let file of files) {
                console.log('[INSPIRATION] Processing file:', file.name, 'type:', file.type);
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imageData = e.target.result;
                        console.log('[INSPIRATION] Image loaded:', file.name, 'data length:', imageData.length);
                        console.log('[INSPIRATION] Data URI starts with:', imageData.substring(0, 50));
                        uploadedImages.push({
                            name: file.name,
                            data: imageData
                        });
                        console.log('[INSPIRATION] Total uploaded images now:', uploadedImages.length);
                        renderInspirationPreviews();
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        function renderInspirationPreviews() {
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '';

            uploadedImages.forEach((img, index) => {
                const div = document.createElement('div');
                div.style.cssText = 'position: relative;';
                div.innerHTML = `
                    <img src="${img.data}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px; border: 2px solid #E1E7EF;">
                    <button onclick="removeInspirationImage(${index})"
                            style="position: absolute; top: 5px; right: 5px; width: 28px; height: 28px; border-radius: 50%;
                                   background: rgba(215, 61, 79, 0.9); border: none; color: white; font-size: 16px;
                                   cursor: pointer; display: flex; align-items: center; justify-content: center;
                                   box-shadow: 0 2px 4px rgba(0,0,0,0.2);"
                            title="Remove image">√ó</button>
                `;
                preview.appendChild(div);
            });
        }

        function removeInspirationImage(index) {
            uploadedImages.splice(index, 1);
            renderInspirationPreviews();
        }

        // Drag and drop
        const uploadArea = document.querySelector('.image-upload-area');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#31D7CA';
            uploadArea.style.background = '#F4F7FC';
        });

        uploadArea.addEventListener('dragleave', (e) => {
            uploadArea.style.borderColor = '#E1E7EF';
            uploadArea.style.background = '#fafafa';
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#E1E7EF';
            uploadArea.style.background = '#fafafa';
            handleFiles(e.dataTransfer.files);
        });

        // Start Over function - returns to Step 1
        function startOver() {
            if (confirm('Start a new campaign? All current work will be lost.')) {
                // Hide all steps
                for (let i = 1; i <= 10; i++) {
                    const step = document.getElementById(`step${i}`);
                    if (step) step.classList.add('hidden');
                }

                // Show step 1 and past projects panel
                document.getElementById('step1').classList.remove('hidden');
                document.getElementById('pastProjectsPanel').classList.remove('hidden');

                // Reset form data
                document.getElementById('campaignText').value = '';
                const platformCheckboxes = document.querySelectorAll('.platform-option input[type="checkbox"]');
                platformCheckboxes.forEach(cb => cb.checked = false);

                // Clear global state
                generatedImages = [];
                textOverlays = [];
                finalAds = [];
                selectedPlatforms = [];
                gifResults = [];
                skippedCopyFlow = false;

                // Hide additional preview steps
                const stepPreview = document.getElementById('stepPreview');
                if (stepPreview) stepPreview.classList.add('hidden');
                const stepGeneralPreview = document.getElementById('stepGeneralPreview');
                if (stepGeneralPreview) stepGeneralPreview.classList.add('hidden');

                // Scroll to top
                window.scrollTo(0, 0);
            }
        }

        // ========== PAST PROJECTS (MOCKUP) ==========
        // These are placeholder functions for the archive library mockup
        // Will be connected to actual storage (Google Cloud, etc.) in future version

        function loadProject(projectId) {
            // Mockup: Show alert with project info
            const projectNames = {
                'proj1': "Valentine's Day Campaign",
                'proj2': 'Reddit Q1 Push',
                'proj3': 'Holiday 2025 Campaign',
                'proj4': 'Wedding Season 2025',
                'proj5': "Mother's Day Special",
                'proj6': 'Black Friday Promo'
            };

            const result = confirm(`Load "${projectNames[projectId]}"?\n\nThis will restore all images, ad copy, and settings from this project.\n\n(This is a mockup - actual loading will be available once connected to storage)`);

            if (result) {
                alert('üìÇ Project loading will be available in the next version!\n\nThis mockup shows the UI design. Once connected to Google Cloud or another storage solution, clicking a project will:\n\n‚Ä¢ Load all generated images\n‚Ä¢ Restore ad copy variations\n‚Ä¢ Restore text overlays & logo settings\n‚Ä¢ Restore GIF animations');
            }
        }

        function loadMoreProjects() {
            alert('üìÇ More projects will load here once connected to storage.\n\nThe archive will support:\n‚Ä¢ Pagination for large libraries\n‚Ä¢ Search by project name\n‚Ä¢ Filter by platform\n‚Ä¢ Sort by date or creator');
        }

        // Search and filter functionality (mockup)
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('projectSearch');
            const filterSelect = document.getElementById('projectFilter');

            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    // Mockup: Just show that search is working
                    console.log('[MOCKUP] Searching for:', this.value);
                });
            }

            if (filterSelect) {
                filterSelect.addEventListener('change', function() {
                    // Mockup: Just show that filter is working
                    console.log('[MOCKUP] Filtering by:', this.value);
                    if (this.value !== 'all') {
                        alert(`Filtering by ${this.value.toUpperCase()} projects.\n\n(This is a mockup - filtering will work once connected to storage)`);
                    }
                });
            }
        });
    </script>
</body>
</html>
